# Keyword reference for the .gitlab-ci.yml file: 
# https://gitlab.mpcdf.mpg.de/help/ci/yaml/index.md 

# Struphy test strategy:
# 
# The startup stage with "ci_vars" and "default_venv" is always executed.
#
# At each "push": 
# 1) build .whl
# 2) install from .whl in default and ubuntu:latest 
# 3) compile only in C
# 4) perform all tests (including models --fast) in default and ubuntu:latest
# 
# At each merge into "devel": 
# 1) do nothing
#
# At each merge into "master":
# 1) build .whl
# 2) install from .whl in default 
# 3) update pages 
# 4) deploy to PyPI
# 5) release on GitLab
#
# At "scheduled" pipeline:
# 1) install from PyPI in all available docker images and in default
# 2) compile in C and Fortran
# 3) run all tests (including models --fast) in all available images and in default
#
# A "scheduled" pipeline can be tested via the commit message "test-schedule" (this will use the current build of Struphy from devel).

# The doc can be built via the commit message "make-pages".

# default:
#   image: gitlab-registry.mpcdf.mpg.de/mpcdf/ci-module-image/gcc_12-openmpi_4_1

#   before_script:
#     - date
#     - ls -a
#     - uname -a
#     - module list
#     - module avail
#     - module load gcc/12 openmpi/4 anaconda/3/2023.03 git graphviz/8
#     - module list
#     - make -v
#     - python3 --version
#     - source env_$CI_PIPELINE_ID/bin/activate
#     - pip list

#   # tags:
#   #   - distributedcache

#   artifacts:
#     expire_in: 1 day

stages:
  - performance-tests
  - startup
  - build
  - install
  - test
  - pages
  - release 

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - env_struphy/     # Cache the virtual environment

# Raven private runner
.raven_private_runner:
  # Only run the private runner stage
  # rules:
  #   - if: $CI_PIPELINE_SOURCE == "schedule"
  #   - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  tags:
    - linux
    - raven
    - struphy
    - private
  before_script:
    - echo "Running on Raven private runner with .raven template"
    - echo $USER
    - ls
    - touch "$CI_PIPELINE_ID was here\n" >> ~/private_runner.log
    - pwd
    - module avail
    - module purge
    - module load gcc/12 openmpi/4.1 anaconda/3/2023.03 git/2.43 pandoc/3.1 likwid/5.2
    - module list

private_runner_install:
  stage: performance-tests
  extends: .raven_private_runner
  script:
    - if [ ! -d "env_struphy" ]; then python3 -m venv env_struphy; fi
    - source env_struphy/bin/activate
    - LIKWID_PREFIX=$(realpath $(dirname $(which likwid-topology))/..)
    - export LD_LIBRARY_PATH=$LIKWID_PREFIX/lib
    - export LD_LIBRARY_PATH=/mpcdf/soft/SLE_15/packages/skylake/likwid/gcc_12-12.1.0/5.3.0/lib:$LD_LIBRARY_PATH
    - pip install --upgrade pip
    - pip install pylikwid
    - pip install . # Install struphy
    - struphy
    - python -c "import pylikwid"
    - pyccel --version
    - struphy compile --status
    - struphy compile -y # compiles struphy, psydac with language c 
    - struphy --refresh-models
    - struphy -p
  # artifacts:
  #   paths:
  #     - "env_struphy/"
  #   expire_in: 1 day

mpi_scaling_setup:
  stage: performance-tests
  needs: ["private_runner_install"]
  extends: .raven_private_runner
  script:
    - source env_struphy/bin/activate
    # Set output directory 
    - datetime=$(date +"%Y%m%d_%H%M%S")
    - mkdir -p outputs/$datetime/simulations
    - struphy --set-o outputs/$datetime/simulations
    - struphy -p
    # Run strong scaling simulations (same problem size, increasing number of processes)
    - python3 src/struphy/profiling/generate_params/write_ptest_params.py      # Write parameter files
    - python3 src/struphy/profiling/generate_params/run_simulations.py check   # Check which simulation to run
    - python3 src/struphy/profiling/generate_params/run_simulations.py run     # Run the simulations
    # - struphy test performance --batch batch_raven.sh                          # Submit a job that tests performance of all models
    - echo "Submitted SLURM jobs"
    # Wait for the SLURM jobs to finish
    - while squeue -u $USER | grep str_per; do
        echo "Waiting for struphy job(s) to finish...";
        squeue -u $USER -o "%.18i %.9P %.50j %.8u %.2t %.10M %.6D %R";
        sleep 30;
      done
    - echo "All str_performance jobs finished."
    - echo "Cleaning up output data"
    - rm -rf outputs/$datetime/simulations/*/data/        # Remove data files
    - find outputs/ -type f -name ".*" -exec rm -f {} \;  # Remove hidden files
  artifacts:
    paths:
      - "outputs/"
    expire_in: 30 days

mpi_scaling_plot:
  stage: performance-tests
  needs: ["private_runner_install", "mpi_scaling_setup"]
  extends: .raven_private_runner
  script:
    - source env_struphy/bin/activate
    - datetime=$(ls outputs/ | tail -n 1) # Use the latest datetime folder
    # Plot results
    - for model in "Vlasov" "Maxwell"; do
        struphy likwid_profile
          --output outputs/$datetime/figures/$model 
          --dir outputs/$datetime/simulations/${model}_mpi* 
          --skip main model.integrate 
          --title "MPI scaling, model:${model}";
      done
    - echo "Output saved in outputs/$datetime"
    # Print the files in the output directory
    - find outputs/ -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'
    # Make tar.gz files and upload it to datashare
    - tar -czf outputs_$datetime.tar.gz outputs/$datetime
    - |
      curl -T outputs_"$datetime.tar.gz" -u SK3fLV4VzawfjoW: -H 'X-Requested-With: XMLHttpRequest' -H 'X-Method-Override: PUT' https://datashare.mpcdf.mpg.de/public.php/webdav/
  artifacts:
    paths:
      - "outputs/"
    expire_in: 30 days

# mpi_scaling:
#   stage: performance-tests
#   extends: .raven_private_runner
#   script:
#     # Set output directory 
#     - echo $datetime
#     - datetime=$(date +"%Y%m%d_%H%M%S")
#     - mkdir -p outputs/$datetime/simulations
#     - struphy --set-o outputs/$datetime/simulations
#     - struphy -p
#     # Run strong scaling simulations (same problem size, increasing number of processes)
#     - python3 src/struphy/profiling/generate_params/write_ptest_params.py      # Write parameter files
#     - python3 src/struphy/profiling/generate_params/run_simulations.py check   # Check which simulation to run
#     - python3 src/struphy/profiling/generate_params/run_simulations.py run     # Run the simulations
#     - struphy test performance --batch batch_raven.sh                          # Submit a job that tests performance of all models
#     - echo "Submitted SLURM jobs"
#     # Wait for the SLURM jobs to finish
#     - while squeue -u $USER | grep str_per; do
#         echo "Waiting for struphy job(s) to finish...";
#         squeue -u $USER -o "%.18i %.9P %.50j %.8u %.2t %.10M %.6D %R";
#         sleep 30;
#       done
#     - echo "All str_performance jobs finished."
#     # Clean up data
#     - echo "Cleaning up output data"
#     - rm -rf outputs/$datetime/simulations/*/data/        # Remove data files
#     - find outputs/ -type f -name ".*" -exec rm -f {} \;  # Remove hidden files
#     # Plot results
#     - for model in "Vlasov" "Maxwell"; do
#         struphy likwid_profile
#           --output outputs/$datetime/figures/$model 
#           --dir outputs/$datetime/simulations/${model}_mpi* 
#           --skip main model.integrate 
#           --title "MPI scaling, model:${model}";
#       done
#     - echo "Output saved in outputs/$datetime"
#     # Print the files in the output directory
#     - find outputs/ -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'
#     # Make tar.gz files and upload it to datashare
#     - tar -czf outputs_$datetime.tar.gz outputs/$datetime
#     - |
#       curl -T outputs_"$datetime.tar.gz" -u SK3fLV4VzawfjoW: -H 'X-Requested-With: XMLHttpRequest' -H 'X-Method-Override: PUT' https://datashare.mpcdf.mpg.de/public.php/webdav/
#   artifacts:
#     paths:
#       - "outputs/"
#     expire_in: 30 days
# # python virtual environments into cache
# default_venv:
#   stage: startup 
#   rules:
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_PIPELINE_SOURCE == "push"
#   before_script:
#     - date
#     - ls -a
#     - uname -s # get system info
#     - uname -v
#     - uname -m
#     - uname -o
#     - echo "Hello ${GITLAB_USER_NAME} !"
#     - echo "This is job ${CI_JOB_ID}"
#     - module list
#     - module avail
#     - module load gcc/12 openmpi/4 anaconda/3/2023.03 git graphviz/8
#     - module list
#   script:
#     - pip install -U virtualenv
#     - python3 -m venv env_$CI_PIPELINE_ID
#     - ls
#     - pwd
#     - source env_$CI_PIPELINE_ID/bin/activate
#     - python3 -m pip install --upgrade pip
#     - pip install -U pytest coverage twine
#     - pip list
#   artifacts:
#     name: 'python-env'
#     paths:
#       - env_$CI_PIPELINE_ID/
#     expire_in: 1 day

# # Print some predefined variables: https://gitlab.mpcdf.mpg.de/help/ci/variables/predefined_variables.md
# ci_vars:
#   stage: startup
#   rules:
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "push"
#   dependencies: []
#   before_script:
#     - date
#     - ls -a
#     - module list
#   script:
#     - echo "All environment variables:"
#     - env

# # build on mpcdf server
# default_build:
#   stage: build
#   rules:
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "push"
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:  
#     - pip install -U build
#     - pip list
#     - python3 -m build # build struphy (.whl) 
#   artifacts:
#     name: 'dist'
#     paths:
#       - dist/
#     expire_in: 1 day

# #####################
# ### INSTALL STAGE ###
# #####################

# # language c 
# default_install:
#   stage: install
#   rules:
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#   script:
#     - pip install dist/struphy*.whl
#     - pip show struphy
#     - pip list
#     - struphy
#     - pyccel --version
#     - struphy compile --status
#     - struphy compile -y # compiles struphy, psydac with language c 
#   artifacts:
#     name: 'python-env-installed'
#     paths:
#       - env_$CI_PIPELINE_ID/
#     expire_in: 1 day

# # Cron-job C:
# c_cronjob_install:
#   stage: install
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:
#     - pip install struphy
#     - pip show struphy
#     - pip list
#     - struphy
#     - pyccel --version
#     - struphy compile --status
#     - struphy compile -y # compiles struphy, psydac with language c 
#   artifacts:
#     name: 'python-env-installed'
#     paths:
#       - env_$CI_PIPELINE_ID/
#     expire_in: 1 day

# ##################
# ### TEST STAGE ###
# ##################

# # ubuntu latest 
# Ubuntu_latest:
#   stage: test
#   image: ubuntu:latest
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#   needs: ['default_build']
#   before_script:
#     - date
#     - ls -a
#     - apt update -y && apt clean 
#     - export DEBIAN_FRONTEND=noninteractive
#     - apt install -y software-properties-common
#     - add-apt-repository -y ppa:deadsnakes/ppa
#     - apt update -y
#     - apt install -y python3.11
#     - apt install -y python3.11-dev
#     - apt install -y python3-pip 
#     - apt install -y python3.11-venv 
#     - apt install -y gfortran gcc 
#     - apt install -y liblapack-dev libopenmpi-dev 
#     - apt install -y libblas-dev openmpi-bin 
#     - apt install -y libomp-dev libomp5 
#     - apt install -y git
#     - apt install -y pandoc
#     - apt install -y sqlite3
#     - export OMPI_ALLOW_RUN_AS_ROOT=1
#     - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
#   script:
#     - python3.11 -m pip list
#     - python3.11 -m venv env
#     - source env/bin/activate
#     - pip install dist/struphy*.whl
#     - struphy compile --status
#     - make -v
#     - struphy compile
#     - struphy test models --fast

# # default tests
# c_unit_tests:
#   stage: test
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test unit  
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

# c_model_tests:
#   stage: test
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test models --fast
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

# c_model_cronjob_tests:
#   stage: test
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test models --fast
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all
#   artifacts:
#     name: 'python-env-installed-2'
#     paths:
#       - env_$CI_PIPELINE_ID/
#     expire_in: 1 day

# c_tutorial_tests:
#   stage: test
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test tutorials --fast

# # Cron-job Fortran install, after c tests:
# fortran_cronjob_install:
#   stage: test
#   needs: ["c_model_cronjob_tests"]
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:
#     - pip show struphy
#     - pip list
#     - struphy
#     - pyccel --version
#     - struphy compile --status
#     - struphy compile --language=fortran -y # compiles struphy, psydac with language fortran
#   artifacts:
#     name: 'python-env-installed-3'
#     paths:
#       - env_$CI_PIPELINE_ID/
#     expire_in: 1 day

# fortran_unit_tests:
#   stage: test
#   needs: ["fortran_cronjob_install"]
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test unit 
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

# fortran_model_tests:
#   stage: test
#   needs: ["fortran_cronjob_install"]
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test models --fast
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

# fortran_tutorial_tests:
#   stage: test
#   needs: ["fortran_cronjob_install"]
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   script:
#     - pwd
#     - ls -1
#     - struphy compile --status
#     - struphy test tutorials
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

# # docker image testing (scheduled: struphy from PyPI OR test-schedule: struphy from devel)
# Ubuntu_23_04:
#   stage: test
#   image: ubuntu:23.04
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - ls -a
#     - apt update -y && apt clean 
#     - apt install -y python3-pip 
#     - apt install -y python3-venv
#     - apt install -y gfortran gcc 
#     - DEBIAN_FRONTEND=noninteractive TZ="Europe/Berlin" apt-get install -y liblapack-dev libopenmpi-dev 
#     - apt install -y libblas-dev openmpi-bin 
#     - apt install -y libomp-dev libomp5 
#     - apt install -y git
#     - apt install -y pandoc
#     - export OMPI_ALLOW_RUN_AS_ROOT=1
#     - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
#   script:
#     - python3 -m venv env
#     - source env/bin/activate
#     - pip install --upgrade pip
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - struphy compile
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# struphy_ubuntu_python_3_11:
#   stage: test
#   image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_ubuntu_python_3_11
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - uname -a
#     - ls -a
#     - ls dist/
#     - ls /
#   script:
#     - python3 -V
#     - python3.11 -V
#     - python3.11 -m venv env
#     - source env/bin/activate
#     - pip install --upgrade pip
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - struphy compile
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# Fedora:
#   stage: test
#   image: fedora:latest
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - ls -a
#     - dnf install -y wget yum-utils make openssl-devel bzip2-devel libffi-devel zlib-devel
#     - dnf update -y  
#     - dnf install -y gcc
#     - dnf install -y gfortran  
#     - dnf install -y blas-devel lapack-devel  
#     - dnf install -y openmpi openmpi-devel 
#     - dnf install -y libgomp 
#     - dnf install -y git 
#     - dnf install -y environment-modules 
#     - dnf install -y python3-mpi4py-openmpi 
#     - dnf install -y pandoc
#     - dnf install -y sqlite-devel
#     - wget https://www.python.org/ftp/python/3.10.14/Python-3.10.14.tgz 
#     - tar xzf Python-3.10.14.tgz 
#     - cd Python-3.10.14 
#     - ./configure --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions 
#     - make -j ${nproc} 
#     - make altinstall 
#     - cd ..
#     - pwd
#     - ls  
#     - export OMPI_ALLOW_RUN_AS_ROOT=1
#     - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
#     - mv /usr/local/lib/libpython3.10.a libpython3.10.a.bak
#   script:
#     - python3.10 -V
#     - python3.10 -m venv env
#     - source env/bin/activate
#     - . /etc/profile.d/modules.sh
#     - module load mpi/openmpi-$(arch)
#     - module list 
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - struphy compile 
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# struphy_fedora_python_3_10:
#   stage: test
#   image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_fedora_python_3_10
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - uname -a
#     - ls -a
#     - ls dist/
#     - ls /
#   script:
#     - python3.10 -V
#     - python3.10 -m venv env
#     - source env/bin/activate
#     - . /etc/profile.d/modules.sh
#     - module load mpi/openmpi-$(arch)
#     - module list 
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - struphy compile 
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# OpenSuse:
#   stage: test
#   image: opensuse/tumbleweed:latest
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - ls -a
#     - zypper refresh
#     - zypper install -y python311 python311-devel
#     - zypper install -y python311-pip python3-virtualenv
#     - zypper install -y gcc-fortran gcc 
#     - zypper install -y lapack-devel openmpi-devel 
#     - zypper install -y blas-devel openmpi 
#     - zypper install -y libgomp1 
#     - zypper install -y git 
#     - zypper install -y pandoc 
#     - zypper install -y sqlite3 
#     - zypper install -y vim 
#     - zypper install -y make
#     - python3 -m venv /opensuse_latest/venv
#     - export PATH="/opensuse_latest/venv/bin:$PATH"
#     - export OMPI_ALLOW_RUN_AS_ROOT=1
#     - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
#     - export OMPI_MCA_pml=ob1
#     - export OMPI_MCA_btl=tcp,self
#     - export PATH="/usr/lib64/mpi/gcc/openmpi4/bin/:$PATH"
#     - export LD_LIBRARY_PATH="/usr/lib64/mpi/gcc/openmpi4/lib64:$LD_LIBRARY_PATH"
#   script:
#     - python3 -V
#     - python3 -m pip list
#     - python3 -m venv env
#     - source env/bin/activate
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - struphy compile 
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# struphy_opensuse_python_3_11:
#   stage: test
#   image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_opensuse_python_3_11
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - uname -a
#     - ls -a
#     - ls dist/
#     - ls /
#   script:
#     - python3 -V
#     - python3 -m pip list
#     - python3 -m venv env
#     - source env/bin/activate
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - struphy compile 
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# AlmaLinux:
#   stage: test
#   image: almalinux:latest
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - ls -a
#     - yum install -y wget yum-utils make openssl-devel bzip2-devel libffi-devel zlib-devel
#     - yum update -y 
#     - yum clean all 
#     - yum install -y gcc 
#     - yum install -y gfortran  
#     - yum install -y openmpi openmpi-devel  
#     - yum install -y libgomp 
#     - yum install -y git 
#     - yum install -y environment-modules 
#     - yum install -y sqlite-devel
#     - wget https://www.python.org/ftp/python/3.10.14/Python-3.10.14.tgz 
#     - tar xzf Python-3.10.14.tgz 
#     - cd Python-3.10.14 
#     - ./configure --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions 
#     - make -j ${nproc} 
#     - make altinstall 
#     - cd ..
#     - pwd
#     - ls
#     - export OMPI_ALLOW_RUN_AS_ROOT=1
#     - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
#     - export OMPI_MCA_pml=ob1
#     - export OMPI_MCA_btl=tcp,self
#     - export PATH="/usr/lib64/openmpi/bin:$PATH"
#     - mv /usr/local/lib/libpython3.10.a libpython3.10.a.bak
#   script:
#     - python3.10 -m pip list
#     - python3.10 -m venv env
#     - source env/bin/activate
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - pip list
#     - struphy compile 
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# struphy_almalinux_python_3_10:
#   stage: test
#   image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_almalinux_python_3_10
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#   needs: ['default_build']
#   before_script:
#     - date
#     - uname -a
#     - ls -a
#     - ls dist/
#     - ls /
#   script:
#     - python3.10 -m pip list
#     - python3.10 -m venv env
#     - source env/bin/activate
#     - echo $CI_COMMIT_MESSAGE
#     - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
#     - echo $FILE
#     - pip install $FILE
#     - pip list
#     - struphy compile 
#     - struphy test models --fast
#     - struphy compile --language=fortran -y 
#     - struphy test models --fast

# ###################
# ### PAGES STAGE ###
# ###################

# pages:
#   image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_ubuntu_python_3_11
#   stage: pages
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "true"
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#   needs: ['default_build']
#   before_script:
#     - date
#     - uname -a
#     - ls -a
#     - ls dist/
#     - ls /
#     - apt show pandoc
#     - apt show graphviz
#     - python3 -V
#     - python3.11 -V
#     - python3.11 -m venv env
#     - source env/bin/activate
#     - pip install --upgrade pip
#     - echo $CI_COMMIT_MESSAGE
#     - pip install dist/struphy*.whl
#   script:
#     - struphy -h
#     - struphy compile --status
#     - struphy compile -y
#     - struphy test tutorials
#     - ls $(python3 -c "import struphy as _; print(_.__path__[0])")/io/out
#     #- struphy test timings
#     #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all
#     - cd doc ; make html
#     - mv _build/html/ ../public/
#   artifacts:
#     name: 'pages'
#     paths:
#       - public/

# #####################
# ### RELEASE STAGE ###
# #####################

# deploy:
#   stage: release
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_NAME == "master" 
#   script:
#     - twine upload dist/*

# vars:
#   stage: release
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_NAME == "master"
#   before_script:
#     - date
#     - ls -a
#     - uname -s # get system info
#   script:
#     - echo "VERSION=$(var=$(<pyproject.toml); set -- $var; echo ${14} | sed 's/^.//' | sed 's/.$//')" >> vars.env
#   artifacts:
#     name: 'vars'
#     reports:
#       dotenv: vars.env
#     expire_in: 1 day

# release_job:
#   stage: release
#   image: registry.gitlab.com/gitlab-org/release-cli:latest
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_NAME == "master"
#   needs: ['vars']
#   before_script:
#     - date
#     - ls -a
#     - uname -s # get system info
#   script:
#     - cat /etc/*-release
#     - echo $VERSION
#   release:                                         # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
#     tag_name: 'v$VERSION'                          # The version is incremented per pipeline.
#     name: 'v$VERSION'
#     ref: '$CI_COMMIT_SHA'                          # The tag is created from the pipeline SHA.
#     description: 'CHANGELOG.md'
#     assets:
#       links:
#         - name: 'Documentation'
#           url: 'https://struphy.pages.mpcdf.de/struphy/index.html'
#         - name: 'PyPI'
#           url: 'https://pypi.org/project/struphy/'
