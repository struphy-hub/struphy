# Keyword reference for the .gitlab-ci.yml file: 
# https://gitlab.mpcdf.mpg.de/help/ci/yaml/index.md

# Official language image. Look for the different tagged releases at:
# https://hub.docker.com/r/library/python/tags/

default:

  image: gitlab-registry.mpcdf.mpg.de/mpcdf/module-image

  before_script:
    - module purge
    - module load gcc/12 openmpi/4 anaconda/3/2023.03 git pandoc
    - module list
    - source env_$CI_PIPELINE_ID/bin/activate
    - pip list
    - ENV_PATH=$(python3 -c "import sysconfig; print(sysconfig.get_path('platlib'))")
    #- ENV_PATH=$(python3 -m site --user-site)
    - LIBDIR=$(python3 -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")
    - echo $ENV_PATH
    - echo $LIBDIR
    - ls

  tags:
    - cloud

  cache:
    key: 'python-env'
    paths:
      - env_$CI_PIPELINE_ID/

stages:
  - startup
  - build
  - install
  - test
  - release 
variables:
  PYTHON_VERSION_1: "3.8"
  PYTHON_VERSION_2: "3.9"

# python virtual environment into cache
default_venv:
  stage: startup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    - uname -s # get system info
    - uname -v
    - uname -m
    - uname -o
    - echo "Hello ${GITLAB_USER_NAME} !"
    - echo "This is job ${CI_JOB_ID}"
    - module purge
    - module avail
    - module load gcc/12 openmpi/4 anaconda/3/2023.03 git pandoc
    - module list
  script:
    - echo "Creating virtual environment..."
    - pip install -U virtualenv
    - python3 -m venv env_$CI_PIPELINE_ID
    - ls
    - pwd
    - source env_$CI_PIPELINE_ID/bin/activate
    - python3 -m pip install --upgrade pip
    - pip install -U pytest coverage build twine # somehow the build package is not cached
    - pip list

# Print some predefined variables: https://gitlab.mpcdf.mpg.de/help/ci/variables/predefined_variables.md
ci_vars:
  stage: startup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  cache: []
  before_script:
    - module purge
    - module load gcc/12 openmpi/4 anaconda/3/2023.03 git pandoc
    - module list
  script:
    - echo "All CI predefined variables:"
    - echo $CHAT_CHANNEL
    - echo $CHAT_INPUT
    - echo $CHAT_USER_ID
    - echo $CI
    - echo $CI_API_V4_URL
    - echo $CI_BUILDS_DIR
    - echo $CI_COMMIT_AUTHOR
    - echo $CI_COMMIT_BEFORE_SHA
    - echo $CI_COMMIT_BRANCH
    - echo $CI_COMMIT_DESCRIPTION
    - echo $CI_COMMIT_MESSAGE
    - echo $CI_COMMIT_REF_NAME
    - echo $CI_COMMIT_REF_PROTECTED
    - echo $CI_COMMIT_REF_SLUG
    - echo $CI_COMMIT_SHA
    - echo $CI_COMMIT_SHORT_SHA
    - echo $CI_COMMIT_TAG
    - echo $CI_COMMIT_TIMESTAMP
    - echo $CI_COMMIT_TITLE
    - echo $CI_CONCURRENT_ID
    - echo $CI_CONCURRENT_PROJECT_ID
    - echo $CI_CONFIG_PATH
    - echo $CI_DEBUG_TRACE
    - echo $CI_DEFAULT_BRANCH
    - echo $CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX
    - echo $CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX
    - echo $CI_DEPENDENCY_PROXY_PASSWORD
    - echo $CI_DEPENDENCY_PROXY_SERVER
    - echo $CI_DEPENDENCY_PROXY_USER
    - echo $CI_DEPLOY_FREEZE
    - echo $CI_DEPLOY_PASSWORD
    - echo $CI_DEPLOY_USER
    - echo $CI_DISPOSABLE_ENVIRONMENT
    - echo $CI_ENVIRONMENT_NAME
    - echo $CI_ENVIRONMENT_SLUG
    - echo $CI_ENVIRONMENT_URL
    - echo $CI_ENVIRONMENT_ACTION
    - echo $CI_ENVIRONMENT_TIER
    - echo $CI_HAS_OPEN_REQUIREMENTS
    - echo $CI_JOB_ID
    - echo $CI_JOB_IMAGE
    - echo $CI_JOB_JWT
    - echo $CI_JOB_JWT_V1
    - echo $CI_JOB_JWT_V2
    - echo $CI_JOB_MANUAL
    - echo $CI_JOB_NAME
    - echo $CI_JOB_STAGE
    - echo $CI_JOB_STATUS
    - echo $CI_JOB_TOKEN
    - echo $CI_JOB_URL
    - echo $CI_JOB_STARTED_AT
    - echo $CI_KUBERNETES_ACTIVE
    - echo $CI_NODE_INDEX
    - echo $CI_NODE_TOTAL
    - echo $CI_OPEN_MERGE_REQUESTS
    - echo $CI_PAGES_DOMAIN
    - echo $CI_PAGES_URL
    - echo $CI_PIPELINE_ID
    - echo $CI_PIPELINE_IID
    - echo $CI_PIPELINE_SOURCE
    - echo $CI_PIPELINE_TRIGGERED
    - echo $CI_PIPELINE_URL
    - echo $CI_PIPELINE_CREATED_AT
    - echo $CI_PROJECT_CONFIG_PATH
    - echo $CI_PROJECT_DIR
    - echo $CI_PROJECT_ID
    - echo $CI_PROJECT_NAME
    - echo $CI_PROJECT_NAMESPACE
    - echo $CI_PROJECT_PATH_SLUG
    - echo $CI_PROJECT_PATH
    - echo $CI_PROJECT_REPOSITORY_LANGUAGES
    - echo $CI_PROJECT_ROOT_NAMESPACE
    - echo $CI_PROJECT_TITLE
    - echo $CI_PROJECT_URL
    - echo $CI_PROJECT_VISIBILITY
    - echo $CI_PROJECT_CLASSIFICATION_LABEL
    - echo $CI_REGISTRY_IMAGE
    - echo $CI_REGISTRY_PASSWORD
    - echo $CI_REGISTRY_USER
    - echo $CI_REGISTRY
    - echo $CI_REPOSITORY_URL
    - echo $CI_RUNNER_DESCRIPTION
    - echo $CI_RUNNER_EXECUTABLE_ARCH
    - echo $CI_RUNNER_ID
    - echo $CI_RUNNER_REVISION
    - echo $CI_RUNNER_SHORT_TOKEN
    - echo $CI_RUNNER_TAGS
    - echo $CI_RUNNER_VERSION
    - echo $CI_SERVER_HOST
    - echo $CI_SERVER_NAME
    - echo $CI_SERVER_PORT
    - echo $CI_SERVER_PROTOCOL
    - echo $CI_SERVER_REVISION
    - echo $CI_SERVER_URL
    - echo $CI_SERVER_VERSION_MAJOR
    - echo $CI_SERVER_VERSION_MINOR
    - echo $CI_SERVER_VERSION_PATCH
    - echo $CI_SERVER_VERSION
    - echo $CI_SERVER
    - echo $CI_SHARED_ENVIRONMENT
    - echo $GITLAB_CI
    - echo $GITLAB_FEATURES
    - echo $GITLAB_USER_EMAIL
    - echo $GITLAB_USER_ID
    - echo $GITLAB_USER_LOGIN
    - echo $GITLAB_USER_NAME
    - echo $TRIGGER_PAYLOAD
    - echo $TWINE_PASSWORD
    - echo $TWINE_USERNAME

# Verify the PEP-8 guidelines for your code
linting:
  stage: startup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master"
  cache: []
  before_script:
    - module load anaconda/3/2023.03 
    - pip install -U pylint
  script:
    - FLAGS="--recursive=y --exit-zero --reports=yes"
    - mkdir linting
    - pylint src/struphy/ --output-format=text:linting/struphy.txt $FLAGS
  artifacts:
    paths:
      - linting/

# build on mpcdf server
default_build:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  needs: ["default_venv"]
  script:
    - pip list
    - python3 -m build # build struphy (.whl) 
  artifacts:
    paths:
      - dist/

# Install from wheel and compile on mpcdf cluster arch
default_install:
  stage: install
  needs: ["default_build"]
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pip install dist/struphy*.whl
    - pip show struphy
    - struphy
    - pyccel --version
    - struphy compile --delete
    - struphy compile # compiles struphy, psydac and gvec_to_python
    - ./src/struphy/verify_compilation.sh
    - pip list

# default tests (always)
default_unit_tests:
  stage: test
  needs: ["default_install"]
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pwd
    - ls -1
    - struphy test unit
    - struphy test unit --mpi 2

default_code_tests:
  stage: test
  needs: ["default_install"]
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - pwd
    - ls -1
    - struphy test codes --fast

cronjob_code_tests:
  stage: test
  needs: ["default_install"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pwd
    - ls -1
    - struphy test codes 

ubuntu_tests:
  stage: test
  image: ubuntu:latest
  needs: ["default_build"]
  cache: []
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  before_script:
    - apt update -y && apt clean 
    - apt install -y python3-pip 
    - apt install -y python3.10-venv 
    - apt install -y gfortran gcc 
    - DEBIAN_FRONTEND=noninteractive TZ="Europe/Berlin" apt-get install -y liblapack-dev libopenmpi-dev 
    - apt install -y libblas-dev openmpi-bin 
    - apt install -y libomp-dev libomp5 
    - apt install -y git
    - apt install -y pandoc
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
  script:
    - pip list
    - pip install dist/struphy*.whl
    - struphy compile
    - struphy test codes --fast

ubuntu_20_04_tests:
  stage: test
  image: ubuntu:20.04
  needs: ["default_build"]
  cache: []
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  before_script:
    - apt update -y && apt clean 
    - apt install -y python3-pip 
    - apt install -y python3.8-venv  # Example Python version for Ubuntu 20.04
    - apt install -y gfortran gcc 
    - DEBIAN_FRONTEND=noninteractive TZ="Europe/Berlin" apt-get install -y liblapack-dev libopenmpi-dev 
    - apt install -y libblas-dev openmpi-bin 
    - apt install -y libomp-dev libomp5 
    - apt install -y git
    - apt install -y pandoc
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
  script:
    - pip list
    - pip install dist/struphy*.whl
    - struphy compile
    - struphy test codes --fast

ubuntu_22_04_tests:
  stage: test
  image: ubuntu:22.04
  needs: ["default_build"]
  cache: []
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  before_script:
    - apt update -y && apt clean 
    - apt install -y python3-pip 
    - apt install -y python3.10-venv  # Example Python version for Ubuntu 22.04
    - apt install -y gfortran gcc 
    - DEBIAN_FRONTEND=noninteractive TZ="Europe/Berlin" apt-get install -y liblapack-dev libopenmpi-dev 
    - apt install -y libblas-dev openmpi-bin 
    - apt install -y libomp-dev libomp5 
    - apt install -y git
    - apt install -y pandoc
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
  script:
    - pip list
    - pip install dist/struphy*.whl
    - struphy compile
    - struphy test codes --fast

fedora_tests:
  stage: test
  image: fedora:37
  needs: ["default_build"]
  cache: []
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  before_script:
    - dnf install -y python3-pip 
    - dnf install -y gcc 
    - dnf install -y gfortran  
    - dnf install -y blas-devel lapack-devel  
    - dnf install -y openmpi openmpi-devel 
    - dnf install -y libgomp 
    - dnf install -y git 
    - dnf install -y environment-modules 
    - dnf install -y python3-mpi4py-openmpi 
    - dnf install -y python3-devel 
    - dnf install -y pandoc
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
  script:
    - pip list
    - bash -c ". /etc/profile.d/modules.sh && module load mpi/openmpi-$(arch) && module list && pip install dist/struphy*.whl && struphy compile && struphy test codes --fast" 

# release
deploy:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" 
  needs: ["default_build"]
  script:
    - twine upload dist/*

pages:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "true" 
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
  needs: ["default_install"]
  script:
    - pip show struphy
    - struphy
    - struphy compile
    - struphy tutorials 
    - cd doc ; make html
    - mv _build/html/ ../public/
  artifacts:
    paths:
      - public/

vars:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master"
  before_script:
    - uname -s # get system info
  script:
    - echo "VERSION=$(var=$(<pyproject.toml); set -- $var; echo ${14} | sed 's/^.//' | sed 's/.$//')" >> vars.env
  artifacts:
    reports:
      dotenv: vars.env

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master"
  needs: ['vars']
  before_script:
    - uname -s # get system info
  script:
    - cat /etc/*-release
    - echo $VERSION
  release:                                         # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'v$VERSION'                          # The version is incremented per pipeline.
    name: 'v$VERSION'
    ref: '$CI_COMMIT_SHA'                          # The tag is created from the pipeline SHA.
    description: 'CHANGELOG.md'
    assets:
      links:
        - name: 'Documentation'
          url: 'https://struphy.pages.mpcdf.de/struphy/index.html'
        - name: 'PyPI'
          url: 'https://pypi.org/project/struphy/'

