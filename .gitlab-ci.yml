# Keyword reference for the .gitlab-ci.yml file: 
# https://gitlab.mpcdf.mpg.de/help/ci/yaml/index.md 

# A "scheduled" pipeline can be tested by clicking "Run pipeline" on Gitlab and setting the TEST_SCHEDULED = true.
# The doc can be built by clicking "Run pipeline" on Gitlab and setting the MAKE_PAGES = true.

variables:
  FF_SCRIPT_SECTIONS: "true"
  MAKE_PAGES:
    value: "false"
    options: ["true", "false"]
    description: "''true'' to make pages"
  MAKE_GITLAB_RELEASE:
    value: "false"
    options: ["true", "false"]
    description: "''true'' to make a new release on https://gitlab.mpcdf.mpg.de/struphy/struphy/-/releases"
  TEST_SCHEDULED:
    value: "false"
    options: ["true", "false"]
    description: "''true'' to run the scheduled pipeline"
  UPDATE_IMAGES:
    value: "false"
    options: ["true", "false"]
    description: "''true'' to build all struphy images with buildah."
  STRUPHY_SOURCE:
    value: "."
    options: [".", "-U struphy"]
    description: "Source to install struphy from."
  CLEANUP_MACOS_NMPP:
    value: "false"
    options: ["true", "false"]
    description: "Cleanup the struphy directory on the MacOS server."

stages:
  - startup
  - build_images
  - install
  - test
  - lint
  - pages
  - release 

# --- images ---

.image_gitlab_mpcdf_struphy:
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/mpcdf-gcc-openmpi-with-struphy

.image_ubuntu_struphy:
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/ubuntu-latest-with-struphy

.image_gitlab_mpcdf_gcc_openmp:
  image: gitlab-registry.mpcdf.mpg.de/mpcdf/ci-module-image/gcc_14-openmpi_5_0:2025

.image_ubuntu_latest:
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/ubuntu-latest

# --- job variables ---

.variables_push:
  variables:
    LANGUAGE: 'c'
    OMP: ''

# --- rules ---

# Options for CI_PIPELINE_SOURCE: push, merge_request_event, web, schedule, api
.rules_startup:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED == "false"
      when: never
    - when: always # this is a fix from https://forum.gitlab.com/t/push-to-gitlab-triggers-one-or-two-pipelines/61070/2

.rules_common:
  skip_pages_and_scheduled:
    - if: $TEST_SCHEDULED == "true"
      when: never
    - if: $MAKE_PAGES == "true"
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
      when: never
  release:
    - if: $TEST_SCHEDULED == "true"
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master"

.rules_mr_to_devel:
  rules:
    - !reference [.rules_common, skip_pages_and_scheduled]
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "devel" && $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "318-parameter-file-as-py" && $CI_PIPELINE_SOURCE == "merge_request_event"

.rules_mr_to_master:
  rules:
    - !reference [.rules_common, skip_pages_and_scheduled]
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"
      when: always

.rules_scheduled:
  rules:
    - if: $TEST_SCHEDULED == "true"
    - if: $CI_PIPELINE_SOURCE == "schedule"

.rules_update_images:
  rules:
    - if: $UPDATE_IMAGES == "true"

.rules_pypi_release:
  rules:
    - !reference [.rules_common, release]

.rules_gitlab_release:
  rules:
    - !reference [.rules_common, release]
    - if: $MAKE_GITLAB_RELEASE == "true"

.rules_pages_release:
  rules:
    - !reference [.rules_common, release]
    - if: $MAKE_PAGES == "true"

.rules_cleanup_macos:
  rules:
    - if: $CLEANUP_MACOS_NMPP == "true"

# --- parallel matrices ---

.parallel_matrix_install:
  parallel:
    matrix:
      - LANGUAGE: "fortran"
        OMP: ["", "--omp-pic"]
      # - LANGUAGE: "c"
      #   OMP: [""]

.parallel_matrix_scheduled:
  parallel:
    matrix:
      - LANGUAGE: "fortran"
        OMP: [""] #, "--omp-pic"] # TODO: Enable when unit tests are working with --omp-pic!
      - LANGUAGE: "c"
        OMP: [""]

# --- before scripts ---

.before_script_load_modules:
  before_script:
    - date
    - pwd
    - ls -1a
    - uname -a
    - module list
    - module avail
    # struphy modules
    - module load gcc/14 openmpi/5.0 python-waterboa/2024.06 git graphviz/8 
    # gvec modules and variables
    - module load cmake netcdf-serial mkl hdf5-serial 
    - export FC=`which gfortran` 
    - export CC=`which gcc` 
    - export CXX=`which g++` 
    # verify
    - module list
    - echo "Fortran compiler is ${FC}"
    - make -v
    - python3 --version

.requirements_fedora:
  before_script:
    - !reference [.scripts, inspect_directory]
    # basic
    - dnf install -y wget yum-utils make openssl-devel bzip2-devel libffi-devel zlib-devel
    - dnf update -y  
    # compilers and mpi
    - dnf install -y gcc
    - dnf install -y gfortran  
    - dnf install -y blas-devel lapack-devel  
    - dnf install -y openmpi openmpi-devel 
    # python
    - dnf install -y python3-devel
    - dnf install -y python3-mpi4py-openmpi 
    # gvec
    - dnf install -y g++ cmake netcdf netcdf-devel netcdf-fortran netcdf-fortran-devel pkgconf 
    - export FC=`which gfortran` 
    - export CC=`which gcc`  
    - export CXX=`which g++`
    # additional
    - dnf install -y git 
    - dnf install -y pandoc
    - dnf update -y
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    # virtual env
    - python3 -m venv env
    - source env/bin/activate
    - . /etc/profile.d/modules.sh
    - module load mpi/openmpi-$(arch)
    - module list 

.requirements_opensuse:
  before_script:
    - !reference [.scripts, inspect_directory]
    # basic
    - zypper refresh
    # compilers and mpi
    - zypper install -y gcc-fortran gcc 
    - zypper install -y blas-devel lapack-devel  
    - zypper install -y openmpi openmpi-devel openmpi4-devel
    - zypper install -y libgomp1 
    # python
    - zypper install -y python3 python3-devel
    - zypper install -y python3-pip python3-virtualenv python3-pkgconfig
    # gvec
    - zypper install -y gcc-c++ cmake netcdf 
    - zypper addrepo -G https://download.opensuse.org/repositories/science/openSUSE_Tumbleweed/science.repo 
    - zypper install -y netcdf-fortran-devel 
    - export FC=`which gfortran`  
    - export CC=`which gcc`  
    - export CXX=`which g++`
    # additional
    - zypper install -y git 
    - zypper install -y pandoc 
    - zypper install -y vim 
    - zypper install -y make
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    - export OMPI_MCA_pml=ob1
    - export OMPI_MCA_btl=tcp,self
    - export PATH="/usr/lib64/mpi/gcc/openmpi4/bin/:$PATH"
    - export LD_LIBRARY_PATH="/usr/lib64/mpi/gcc/openmpi4/lib64:$LD_LIBRARY_PATH"
    - !reference [.scripts, create_venv]

.requirements_almalinux:
  before_script:
    - !reference [.scripts, inspect_directory]
    # basic
    - yum install -y wget yum-utils make openssl-devel bzip2-devel libffi-devel zlib-devel
    - yum update -y 
    - yum clean all 
    # compilers and mpi
    - yum install -y gcc 
    - yum install -y gfortran  
    - yum install -y openmpi openmpi-devel  
    - yum install -y libgomp
    - yum install -y environment-modules 
    # python
    - wget https://www.python.org/ftp/python/3.12.8/Python-3.12.8.tgz 
    - tar xzf Python-3.12.8.tgz 
    - cd Python-3.12.8 
    - ./configure --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions 
    - make -j ${nproc} 
    - make altinstall 
    - alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.12 1
    - alternatives --set python3 /usr/local/bin/python3.12
    - mv /usr/local/lib/libpython3.12.a libpython3.12.a.bak
    - python3 -V
    - cd ..
    - pwd
    - ls
    # additional 
    - yum install -y git
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    - export OMPI_MCA_pml=ob1
    - export OMPI_MCA_btl=tcp,self
    - export PATH="/usr/lib64/openmpi/bin:$PATH"
    # gvec
    - yum install -y g++ cmake which flexiblas-devel
    - yum install -y epel-release 
    - yum install -y netcdf-devel netcdf-fortran-devel 
    - export FC=`which gfortran`  
    - export CC=`which gcc`  
    - export CXX=`which g++`
    # virtual env
    - python3 -m pip list
    - python3 -m venv env
    - source env/bin/activate

# --- scripts ---

.scripts:
  inspect_directory:
    - date
    - pwd
    - ls -1a
    - uname -a
    - ls dist/ || true
  create_venv:
    - python3 -m venv env_${CI_PIPELINE_ID}
    - source env_${CI_PIPELINE_ID}/bin/activate
    - python3 --version
    - pip install -U pip
    - python3 -m pip list
  source_env_matrix:
    - echo env_${CI_PIPELINE_ID}_${LANGUAGE}_${OMP}
    - source env_${CI_PIPELINE_ID}_${LANGUAGE}_${OMP}/bin/activate
    - python3 -m pip list
    - python3 --version
  source_env_matrix_push:
    - ls /
    - echo struphy_${LANGUAGE}_${OMP}
    - cd /struphy_${LANGUAGE}_${OMP}
    - source env_${LANGUAGE}_${OMP}/bin/activate
    - python3 -m pip list
    - python3 --version
  create_venv_matrix:
    - python3 -m ensurepip --upgrade
    - python3 -m pip install --upgrade pip
    - echo env_${CI_PIPELINE_ID}_${LANGUAGE}_${OMP}
    - python3 -m venv env_${CI_PIPELINE_ID}_${LANGUAGE}_${OMP}
    - source env_${CI_PIPELINE_ID}_${LANGUAGE}_${OMP}/bin/activate
    - pip install -U pip
    - python3 -m pip list
    - python3 --version
  install_pyccel_devel:
    - !reference [.scripts, source_env_matrix_push]
    - git status
    - git fetch origin
    - echo $CI_COMMIT_REF_NAME
    - git checkout $CI_COMMIT_REF_NAME
    - git pull
    - pip uninstall psydac pyccel -y
    - echo $STRUPHY_SOURCE
    - pip install -e $(echo $STRUPHY_SOURCE)[phys]
    - struphy compile -d -y
    - !reference [.scripts, compile_matrix]
  install_on_push:
    - !reference [.scripts, source_env_matrix_push]
    - git status
    - git fetch origin
    - echo $CI_COMMIT_REF_NAME
    - git checkout $CI_COMMIT_REF_NAME
    - git pull
    - echo $STRUPHY_SOURCE
    - pip install -e $(echo $STRUPHY_SOURCE)[phys,mpi]
    - !reference [.scripts, compile_matrix]
  install:
    - echo $STRUPHY_SOURCE
    - pip install $(echo $STRUPHY_SOURCE)[phys,mpi]
    - pip show struphy
    - pip list
    - struphy -h
  install_base:
    - echo $STRUPHY_SOURCE
    - pip install $(echo $STRUPHY_SOURCE)[mpi]
    - pip show struphy
    - pip list
    - struphy -h
  install_no_binary:
    - echo $STRUPHY_SOURCE
    - pip install $(echo $STRUPHY_SOURCE)[phys,mpi] --no-binary mpi4py
    - pip show struphy
    - pip list
    - struphy -h
  install_base_no_binary:
    - echo $STRUPHY_SOURCE
    - pip install $(echo $STRUPHY_SOURCE)[mpi] --no-binary mpi4py
    - pip show struphy
    - pip list
    - struphy -h
  install_all:
    - pip install -U pip
    - echo $STRUPHY_SOURCE
    - pip install $(echo $STRUPHY_SOURCE)[all] --no-cache-dir
    - pip show struphy
    - pip list
    - struphy -h
  compile:
    - pyccel --version
    - struphy compile --status
    - struphy compile -y
    - |
      struphy compile -y || (
        echo "Initial compile failed. Removing compiled kernels and trying again..." &&
        struphy compile -d -y &&
        struphy compile -y
      )
  compile_matrix:
    - pyccel --version
    - struphy compile --status
    - echo ${LANGUAGE} && echo ${OMP}
    - |
      struphy compile --language ${LANGUAGE} ${OMP} -y || (
        echo "Initial compile failed. Removing compiled kernels and trying again..." &&
        struphy compile -d -y &&
        struphy compile --language ${LANGUAGE} ${OMP} -y
      )
  build:
    - pip install -U build
    - python3 -m build
  inspect_struphy:
    - struphy -p
    - struphy -h
    - struphy --refresh-models
    - struphy run -h
  unit_tests:
    - struphy compile --status
    - struphy --refresh-models
    - struphy test unit
  unit_tests_mpi:
    - struphy compile --status
    - struphy --refresh-models
    - struphy test unit --mpi 2
  model_tests:
    - struphy compile --status
    - struphy test LinearMHD
    - struphy test toy
    - struphy test models 
    - struphy test verification 
  model_tests_mpi:
    - struphy compile --status
    - struphy test models 
    - struphy test models --mpi 2
    - struphy test verification --mpi 1
    - struphy test verification --mpi 4
    - struphy test verification --mpi 4 --nclones 2
    - struphy test VlasovAmpereOneSpecies --mpi 2 --nclones 2
  quickstart_tests:
    - struphy -p
    - struphy -h
    - struphy params VlasovAmpereOneSpecies 
    - ls -1a
    - mv params_VlasovAmpereOneSpecies.py test.py
    - python3 test.py
    - ls sim_1/
    - mpirun -n 2 python3 test.py
    - LINE_PROFILE=1 mpirun -n 2 python3 test.py
    # - struphy pproc my_first_sim
    # - ls my_first_sim/post_processing/fields_data/
    # - ls my_first_sim/post_processing/kinetic_data/
    # - struphy params VlasovMaxwellOneSpecies --options
    # - struphy run -i test.yml -o my_first_sim_1clone --mpi 4 --nclones 1
    # - struphy run -i test.yml -o my_first_sim_2clone --mpi 4 --nclones 2
    # - struphy run -i test.yml -o my_first_sim_4clone --mpi 4 --nclones 4
    # - struphy pproc my_first_sim_1clone my_first_sim_2clone my_first_sim_4clone
  tutorial_tests:
    - pwd
    - ls -1a
    - which python
    - jupyter nbconvert --to notebook --execute tutorials/*.ipynb
  build_images:
    - buildah images
    - buildah build -t gitlab-registry.mpcdf.mpg.de/struphy/struphy/almalinux-latest -f docker/almalinux-latest.dockerfile .
    - buildah build -t gitlab-registry.mpcdf.mpg.de/struphy/struphy/fedora-latest -f docker/fedora-latest.dockerfile .
    - buildah build -t gitlab-registry.mpcdf.mpg.de/struphy/struphy/mpcdf-gcc-openmpi-with-struphy -f docker/mpcdf-gcc-openmpi-with-struphy.dockerfile .
    - buildah build -t gitlab-registry.mpcdf.mpg.de/struphy/struphy/opensuse-latest -f docker/opensuse-latest.dockerfile .
    - buildah build -t gitlab-registry.mpcdf.mpg.de/struphy/struphy/ubuntu-latest-with-struphy -f docker/ubuntu-latest-with-struphy.dockerfile .
    - buildah build -t gitlab-registry.mpcdf.mpg.de/struphy/struphy/ubuntu-latest -f docker/ubuntu-latest.dockerfile .
  push_images:
    - buildah push gitlab-registry.mpcdf.mpg.de/struphy/struphy/almalinux-latest
    - buildah push gitlab-registry.mpcdf.mpg.de/struphy/struphy/fedora-latest
    - buildah push gitlab-registry.mpcdf.mpg.de/struphy/struphy/mpcdf-gcc-openmpi-with-struphy
    - buildah push gitlab-registry.mpcdf.mpg.de/struphy/struphy/opensuse-latest
    - buildah push gitlab-registry.mpcdf.mpg.de/struphy/struphy/ubuntu-latest-with-struphy
    - buildah push gitlab-registry.mpcdf.mpg.de/struphy/struphy/ubuntu-latest

# --- artifacts ---

.artifacts_scheduled:
  artifacts:
    name: 'python-env-installed-${LANGUAGE}-${OMP}'
    paths:
      - env_${CI_PIPELINE_ID}_${LANGUAGE}_${OMP}
    expire_in: 1 day

#####################
### STARTUP STAGE ###
#####################

update_images_buildah:
  tags: [podman] #necessary to run on the correct runner
  stage: build_images
  image: quay.io/buildah/stable #stable buildah image should suffice
  extends:
    - .rules_update_images
  variables:
    BUILDAH_FORMAT: docker #necessary
    BUILDAH_ISOLATION: chroot #necessary
  before_script:
    - !reference [.scripts, inspect_directory]
    - buildah login -u $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - !reference [.scripts, build_images]
    - !reference [.scripts, push_images]

# Print predefined variables: https://gitlab.mpcdf.mpg.de/help/ci/variables/predefined_variables.md
ci_vars:
  stage: startup
  extends:
    - .rules_startup
    - .image_gitlab_mpcdf_gcc_openmp
    - .before_script_load_modules
  script:
    - echo "All environment variables:"
    - env

inspect_repo:
  stage: startup
  extends:
    - .rules_startup
  script:
    - curl https://raw.githubusercontent.com/AlDanial/cloc/master/cloc > cloc
    - chmod +x cloc
    - ./cloc --version
    - ./cloc $(git ls-files)

#####################
### PUSH PIPELINE ###
#####################

# check_struphy_simulation_params:
#   stage: test
#   extends:
#     - .rules_mr_to_devel
#     - .image_gitlab_mpcdf_struphy
#     - .before_script_load_modules
#     - .variables_push
#   script:
#     - !reference [.scripts, install_on_push]
#     - git clone https://gitlab.mpcdf.mpg.de/struphy/struphy-simulations.git
#     - |
#       for file in struphy-simulations/**/*.yml; do
#         echo "Checking $file"
#         # TODO: How to deduce the model?
#         struphy params LinearVlasovAmpereOneSpecies --check-file $file
#       done

test_cupy:
  tags: [nvidia-cc80]
  image: gitlab-registry.mpcdf.mpg.de/mpcdf/ci-module-image/nvhpcsdk_24-openmpi_5_0:2025
  stage: test
  extends:
    - .rules_startup
  before_script:
    - module avail
    - module list
    - module purge
    - module load nvhpcsdk/24 openmpi/5.0 python-waterboa/2024.06 gcc/13
  script:
    - ls
    - nvidia-smi
    # Install cupy
    - python3 -m pip install --user cupy-cuda12x
    - python3 -c "import cupy as cp"
    - python3 -m pip install cunumpy
    # Test numpy backend
    - python3 src/struphy/utils/cupy_vs_numpy.py
    # Test cupy backend
    - export ARRAY_BACKEND=cupy
    - python3 src/struphy/utils/cupy_vs_numpy.py

install_tests:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .parallel_matrix_install
  script:
    - !reference [.scripts, install_on_push]

unit_tests:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_on_push]
    - pip show mpi4py
    - pip uninstall -y mpi4py
    - pip list
    - !reference [.scripts, unit_tests]

unit_tests_mpi:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_on_push]
    - !reference [.scripts, unit_tests_mpi]

tests_pyccel_devel:
  stage: test
  extends:
    - .rules_scheduled
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_pyccel_devel]
    - !reference [.scripts, unit_tests]
    - !reference [.scripts, model_tests_mpi]

model_tests:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_on_push]
    - pip show mpi4py
    - pip uninstall -y mpi4py
    - pip list
    - !reference [.scripts, model_tests]

model_tests_mpi:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_on_push]
    - !reference [.scripts, model_tests_mpi]

quickstart_tests:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_on_push]
    - !reference [.scripts, quickstart_tests]

# tutorial_tests:
#   stage: test
#   extends:
#     - .rules_mr_to_devel
#     - .image_gitlab_mpcdf_struphy
#     - .before_script_load_modules
#     - .variables_push
#   script:
#     - !reference [.scripts, install_on_push]
#     - !reference [.scripts, tutorial_tests]

pages_tests:
  stage: test
  extends:
    - .rules_scheduled
    - .image_gitlab_mpcdf_struphy
    - .before_script_load_modules
    - .variables_push
  script:
    - !reference [.scripts, install_on_push]
    - !reference [.scripts, inspect_struphy]
    - module load pandoc
    - module list
    - pip install .[doc]
    - |
      struphy compile -y || (
        echo "Initial compile failed. Removing compiled kernels and trying again..." &&
        struphy compile -d -y &&
        struphy compile -y
      )
    - cd doc ; make html
    - mv _build/html/ $CI_PROJECT_DIR/documentation/
  artifacts:
    expose_as: 'Documentation'
    paths:
      - documentation/

ubuntu_latest:
  stage: test
  extends:
    - .rules_mr_to_devel
    - .image_ubuntu_struphy
    - .variables_push
  script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, install_on_push]
    - !reference [.scripts, quickstart_tests]
    - !reference [.scripts, model_tests_mpi]

macos_nmpp:
  stage: test
  tags: [macos, nmpp, private]
  needs: []
  variables:
    # Job ID changes for each job, so reusing the directory becomes impossible,
    # therefore, the fetch strategy also becomes unusable
    GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_PROJECT_NAME/$CI_JOB_ID/$CI_CONCURRENT_PROJECT_ID
    _JOB_PATH: $CI_BUILDS_DIR/$CI_PROJECT_NAME/$CI_JOB_ID
  extends:
    - .rules_mr_to_devel
    - .variables_push
  before_script:
    # - brew install cmake
    - brew link --overwrite cmake
    - cmake --version 
    - make -v
    - printenv
    - system_profiler SPHardwareDataType
    - export FC=`which gfortran` # for gvec
    - export CC=`which gcc` # for gvec
    - export CXX=`which g++` # for gvec
  script:
    - !reference [.scripts, create_venv]
    - !reference [.scripts, install]
    - !reference [.scripts, compile]
    - !reference [.scripts, quickstart_tests]
    - !reference [.scripts, model_tests_mpi]
  after_script:
    - pwd
    - ls -a
    - echo $_JOB_PATH
    - ls -a $_JOB_PATH 
    - rm -rf $_JOB_PATH

cleanup_macos:
  stage: test
  tags: [macos, nmpp, private]
  needs: []
  extends:
    - .rules_cleanup_macos
  before_script:
    - make -v
    - printenv
    - system_profiler SPHardwareDataType
  script:
    - _STRUPHY_PATH=$CI_BUILDS_DIR/$CI_PROJECT_NAME
    - pwd
    - ls -a
    - echo $_STRUPHY_PATH
    - ls -a $_STRUPHY_PATH
    - rm -rf $_STRUPHY_PATH/*
    - ls -a $_STRUPHY_PATH

##########################
### SCHEDULED PIPELINE ###
##########################


install_scheduled:
  stage: install
  needs: []
  extends:
    - .rules_scheduled
    - .image_gitlab_mpcdf_gcc_openmp
    - .before_script_load_modules
    - .parallel_matrix_scheduled
    - .artifacts_scheduled
  script:
    - !reference [.scripts, create_venv_matrix]
    - !reference [.scripts, install_no_binary]
    - !reference [.scripts, compile_matrix]

compile_timing:
  stage: install
  needs: []
  extends:
    - .image_gitlab_mpcdf_gcc_openmp
    - .before_script_load_modules
    - .rules_scheduled
  script:
    - !reference [.scripts, create_venv]
    - !reference [.scripts, install_no_binary]
    - pyccel --version
    - struphy compile --status
    - struphy compile --delete
    - struphy compile --time-execution -y --language c > timings_c.txt
    - struphy compile --delete
    - struphy compile --time-execution -y --language fortran > timings_fortran.txt
    - |
      cat << 'EOF' > check_pyccel.sh
      #!/bin/bash
      grep 'pyccel --libdir' timings_c.txt | sed -E 's|.*/site-packages/||' | while read filepath; do
        echo "========================================"
        echo "Kernel: $filepath"
        echo "-------------------- Timers -------------------------"
        echo "# Language: C"
        grep -A 11 "pyccel.*${filepath}" timings_c.txt | tail -n +3
        echo "# Language: Fortran"
        grep -A 13 "pyccel.*${filepath}" timings_fortran.txt | tail -n +3
      done
      EOF
    - cat check_pyccel.sh
    - chmod +x check_pyccel.sh
    - ./check_pyccel.sh

test_build:
  stage: test
  extends:
    - .image_gitlab_mpcdf_gcc_openmp
    - .rules_scheduled
    - .before_script_load_modules
  needs: []
  script:
    - !reference [.scripts, create_venv]
    - !reference [.scripts, build]
    - pip install $(echo dist/struphy*.whl) --no-cache-dir --no-binary mpi4py

unit_tests_scheduled:
  stage: test
  extends:
    - .image_gitlab_mpcdf_gcc_openmp
    - .rules_scheduled
    - .parallel_matrix_scheduled
    - .before_script_load_modules
  script:
    - !reference [.scripts, source_env_matrix]
    - !reference [.scripts, unit_tests]

model_tests_scheduled:
  stage: test
  extends:
    - .image_gitlab_mpcdf_gcc_openmp
    - .rules_scheduled
    - .parallel_matrix_scheduled
    - .before_script_load_modules
  script:
    - !reference [.scripts, source_env_matrix]
    - !reference [.scripts, model_tests_mpi]

check_release_dependencies:
  stage: test
  extends:
    - .image_gitlab_mpcdf_gcc_openmp
    - .before_script_load_modules
    - .rules_mr_to_master
  script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - !reference [.scripts, install_all]
    - python src/struphy/utils/set_release_dependencies.py
    - |
      if git diff --exit-code pyproject.toml; then
        echo "pyproject.toml has not changed, dependencies are set correctly!"
      else
        echo "pyproject.toml has changed, dependencies are set incorrectly!"
        echo "Run python src/struphy/utils/set_release_dependencies.py to update pyproject.toml"
        exit 1
      fi

Ubuntu-latest-from-registry:
  stage: test
  needs: []
  extends:
    - .image_ubuntu_latest
    - .rules_scheduled
    - .parallel_matrix_scheduled
  before_script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
  script:
    - !reference [.scripts, install]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Fedora-latest:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
    - .requirements_fedora
  image: fedora:latest
  script:
    - !reference [.scripts, install]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Fedora-latest-from-registry:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/fedora-latest
  before_script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - . /etc/profile.d/modules.sh
    - module load mpi/openmpi-$(arch)
    - module list
  script:
    - !reference [.scripts, install]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Fedora-latest-from-registry-base:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/fedora-latest
  before_script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - . /etc/profile.d/modules.sh
    - module load mpi/openmpi-$(arch)
    - module list
  script:
    - !reference [.scripts, install_base]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

OpenSuse-latest:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
    - .requirements_opensuse
  image: opensuse/tumbleweed:latest
  script:
    - !reference [.scripts, install]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Opensuse-latest-from-registry:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/opensuse-latest
  before_script:
    - !reference [.scripts, inspect_directory]
    - set -x
    - !reference [.scripts, create_venv]
  script:
    - !reference [.scripts, install]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Opensuse-latest-from-registry-base:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/opensuse-latest
  before_script:
    - !reference [.scripts, inspect_directory]
    - set -x
    - !reference [.scripts, create_venv]
  script:
    - !reference [.scripts, install_base]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

AlmaLinux-latest:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
    - .requirements_almalinux
  image: almalinux:latest
  script:
    - !reference [.scripts, install_no_binary]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Almalinux-latest-from-registry:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/almalinux-latest
  before_script:
    - !reference [.scripts, inspect_directory]
    - python3 -m ensurepip --upgrade
    - python3 -m pip install --upgrade pip
    - !reference [.scripts, create_venv]
  script:
    - !reference [.scripts, install_no_binary]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

Almalinux-latest-from-registry-base:
  stage: test
  needs: []
  extends:
    - .rules_scheduled
    - .parallel_matrix_scheduled
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/almalinux-latest
  before_script:
    - !reference [.scripts, inspect_directory]
    - python3 -m ensurepip --upgrade
    - python3 -m pip install --upgrade pip
    - !reference [.scripts, create_venv]
  script:
    - !reference [.scripts, install_base_no_binary]
    - !reference [.scripts, compile_matrix]
    - !reference [.scripts, model_tests_mpi]

##################
### LINT STAGE ###
##################

# Run in weekly CI pipeline only
lint_full_repo_report:
  stage: lint
  needs: []
  extends:
    - .rules_scheduled
    - .image_ubuntu_latest
  script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - pip install -e .[dev] # We have to install struphy in editable mode for struphy lint to work
    - !reference [.scripts, inspect_struphy]
    - struphy lint all --output-format report
  allow_failure: true
  artifacts:
    expose_as: 'Branch lint report'
    paths:
      - code_analysis_report.html
    expire_in: 1 month

# Lint struphy with `struphy lint`
lint_repo:
  stage: lint
  needs: []
  extends:
    - .rules_mr_to_devel
    - .image_ubuntu_latest
  script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - pip install -e .[dev] # We have to install struphy in editable mode for struphy lint to work
    - !reference [.scripts, inspect_struphy]
    # Lint all files in current branch, FAIL the CI pipeline if any files are incorrectly formatted
    - struphy lint all --output-format plain --verbose

lint_repo_temporary:
  stage: lint
  needs: []
  extends:
    - .rules_startup
    - .image_ubuntu_latest
  script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - pip install -e .[dev] # We have to install struphy in editable mode for struphy lint to work
    - !reference [.scripts, inspect_struphy]
    # Lint all files in current branch, FAIL the CI pipeline if any files are incorrectly formatted
    - struphy lint all --output-format plain --verbose

# Lint struphy with `struphy lint`
lint_branch_report:
  stage: lint
  needs: []
  extends:
    - .rules_mr_to_devel
    - .image_ubuntu_latest
  script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - pip install -e .[dev] # We have to install struphy in editable mode for struphy lint to work
    - !reference [.scripts, inspect_struphy]
    - struphy lint branch --output-format report
  allow_failure: true
  artifacts:
    expose_as: 'Branch lint report'
    paths:
      - code_analysis_report.html
    expire_in: 1 month

###################
### PAGES STAGE ###
###################
pages:
  stage: pages
  extends:
    - .image_ubuntu_latest
    - .rules_pages_release
  before_script:
    - !reference [.scripts, inspect_directory]
    - !reference [.scripts, create_venv]
    - apt show pandoc
    - apt show graphviz
    - echo $CI_COMMIT_MESSAGE
    - pip install .[doc]
  script:
    - !reference [.scripts, inspect_struphy]
    - !reference [.scripts, compile]
    - cd doc ; make html
    - mv _build/html/ $CI_PROJECT_DIR/public/
  artifacts:
    name: 'pages'
    paths:
      - public/

#####################
### RELEASE STAGE ###
#####################

deploy:
  stage: release
  extends:
    - .rules_pypi_release
    - .image_gitlab_mpcdf_gcc_openmp
    - .before_script_load_modules
  script:
    - !reference [.scripts, create_venv]
    - !reference [.scripts, build]
    - pip install -U twine
    - twine upload dist/*

vars:
  stage: release
  extends:
    - .rules_gitlab_release
  before_script:
    - !reference [.scripts, inspect_directory]
  script:
    - var=$(<pyproject.toml)
    - echo $var
    - set -- $var
    - echo ${16}
    - for (( i=1; i <= "$#"; i++ )); do if (( ${i} < 30 )); then echo ${i}; echo ${!i}; fi done
    - for (( i=1; i <= "$#"; i++ )); do if [[ ${!i} == "version" ]]; then echo ${i}; echo ${!i}; index=$((${i} + 2)); fi done    
    - echo $index 
    - VERSION_STR=${!index}
    - echo $VERSION_STR
    - echo "VERSION=$(echo $VERSION_STR | sed 's/^.//' | sed 's/.$//')"
    - echo "VERSION=$(echo $VERSION_STR | sed 's/^.//' | sed 's/.$//')" >> vars.env
  artifacts:
    name: 'vars'
    reports:
      dotenv: vars.env
    expire_in: 1 day

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  extends:
    - .rules_gitlab_release
  needs: ['vars']
  before_script:
    - !reference [.scripts, inspect_directory]
  script:
    - cat /etc/*-release
    - echo $VERSION
  release:                                         # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'v$VERSION'                          # The version is incremented per pipeline.
    name: 'v$VERSION'
    ref: '$CI_COMMIT_SHA'                          # The tag is created from the pipeline SHA.
    description: 'CHANGELOG.md'
    assets:
      links:
        - name: 'Documentation'
          url: 'https://struphy.pages.mpcdf.de/struphy/index.html'
        - name: 'PyPI'
          url: 'https://pypi.org/project/struphy/'
