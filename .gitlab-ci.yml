# Keyword reference for the .gitlab-ci.yml file: 
# https://gitlab.mpcdf.mpg.de/help/ci/yaml/index.md 

# Struphy test strategy:
# 
# The startup stage with "ci_vars" and "default_venv" is always executed.
#
# At each "push": 
# 1) build .whl
# 2) install from .whl in default and ubuntu:latest 
# 3) compile only in C
# 4) perform all tests (including models --fast) in default and ubuntu:latest
# 
# At each merge into "devel": 
# 1) do nothing
#
# At each merge into "master":
# 1) build .whl
# 2) install from .whl in default 
# 3) update pages 
# 4) deploy to PyPI
# 5) release on GitLab
#
# At "scheduled" pipeline:
# 1) install from PyPI in all available docker images and in default
# 2) compile in C and Fortran
# 3) run all tests (including models --fast) in all available images and in default
#
# A "scheduled" pipeline can be tested via the commit message "test-schedule" (this will use the current build of Struphy from devel).

# The doc can be built via the commit message "make-pages".

default:
  image: gitlab-registry.mpcdf.mpg.de/mpcdf/ci-module-image/gcc_12-openmpi_4_1

  before_script:
    - date
    - ls -a
    - uname -a
    - module list
    - module avail
    - module load gcc/12 openmpi/4 anaconda/3/2023.03 git graphviz/8
    - module list
    - make -v
    - python3 --version
    - source env_$CI_PIPELINE_ID/bin/activate
    - pip list

  # tags:
  #   - distributedcache

  artifacts:
    expire_in: 1 day

stages:
  - startup
  - build
  - install
  - test
  - lint
  - pages
  - release 

# python virtual environments into cache
default_venv:
  stage: startup 
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "push"
  before_script:
    - date
    - ls -a
    - uname -s # get system info
    - uname -v
    - uname -m
    - uname -o
    - echo "Hello ${GITLAB_USER_NAME} !"
    - echo "This is job ${CI_JOB_ID}"
    - module list
    - module avail
    - module load gcc/12 openmpi/4 anaconda/3/2023.03 git graphviz/8
    - module list
  script:
    - pip install -U virtualenv
    - python3 -m venv env_$CI_PIPELINE_ID
    - ls
    - pwd
    - source env_$CI_PIPELINE_ID/bin/activate
    - python3 -m pip install --upgrade pip
    - pip install -U pytest coverage twine
    - pip list
  artifacts:
    name: 'python-env'
    paths:
      - env_$CI_PIPELINE_ID/
    expire_in: 1 day

# Print some predefined variables: https://gitlab.mpcdf.mpg.de/help/ci/variables/predefined_variables.md
ci_vars:
  stage: startup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
  dependencies: []
  before_script:
    - date
    - ls -a
    - module list
  script:
    - echo "All environment variables:"
    - env

# build on mpcdf server
default_build:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:  
    - pip install -U build
    - pip list
    - python3 -m build # build struphy (.whl) 
  artifacts:
    name: 'dist'
    paths:
      - dist/
    expire_in: 1 day

#####################
### INSTALL STAGE ###
#####################

# language c 
default_install:
  stage: install
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - pip install dist/struphy*.whl
    - pip show struphy
    - pip list
    - struphy
    - pyccel --version
    - struphy compile --status
    - struphy compile -y # compiles struphy, psydac with language c 
  artifacts:
    name: 'python-env-installed'
    paths:
      - env_$CI_PIPELINE_ID/
    expire_in: 1 day

# Cron-job C:
c_cronjob_install:
  stage: install
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pip install struphy
    - pip show struphy
    - pip list
    - struphy
    - pyccel --version
    - struphy compile --status
    - struphy compile -y # compiles struphy, psydac with language c 
  artifacts:
    name: 'python-env-installed'
    paths:
      - env_$CI_PIPELINE_ID/
    expire_in: 1 day

##################
### LINT STAGE ###
##################

# Template for linting Python files with flake8 and pylint
.lint_template:
  image: gitlab-registry.mpcdf.mpg.de/mpcdf/ci-module-image/gcc_12-openmpi_4_1
  script:
    - date
    - module load gcc/12 openmpi/4 anaconda/3/2023.03 git graphviz/8
    - module list
    - python3 --version
    - source env_$CI_PIPELINE_ID/bin/activate
    - pip list
    # Install linters
    - pip install flake8 pylint
    # Check if any Python files were found to lint
    - if [ -z "$LINT_FILES" ]; then echo "No files to lint."; exit 0; fi
    - mkdir -p lint_results/
    # Lint with flake8
    - flake8 $LINT_FILES > lint_results/flake8_report.txt || true
    # Lint with pylint and display the score for each file
    - echo "Running pylint on individual files..."
    - |
      for file in $LINT_FILES; do
        echo "Linting $file..."
        echo "Linting $file..." >> lint_results/pylint_report.txt
        # Run pylint and store output in a temporary file
        pylint --score=y "$file" > temp_pylint_output.txt || true
        # Append output to the main pylint report file
        cat temp_pylint_output.txt >> lint_results/pylint_report.txt
        # Extract and display the score line
        grep 'Your code has been rated at' temp_pylint_output.txt
        echo ""
        echo "------------------------"
        echo "------------------------" >> lint_results/pylint_report.txt
        echo "------------------------" >> lint_results/pylint_report.txt
      done
    - rm -f temp_pylint_output.txt
  artifacts:
    paths:
      - lint_results/
    expire_in: 30 days
  allow_failure: true

# Generate linting reports with pylint and flake8 of full repo
# Run in weekly CI pipeline only
full_repo_lint_reports:
  stage: lint
  extends:
    - .lint_template
  rules:
    # Only run full lint report with pylint and flake8 on the scheduled CI pipeline
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    # Find all .py files, excluding those with __XYZ__ in their path
    - LINT_FILES=$(find src/struphy -name "*.py" ! -path "*__*__*")
    - echo "All Python files for full lint:"
    - echo "$LINT_FILES"

# Generate linting reports with pylint and flake8 of files changed in the current branch
# Don't run the check in the scheduled CI pipeline
branch_lint_reports:
  extends:
    - .lint_template
  stage: lint
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  before_script:
    # Get changed Python files between the current branch and origin/devel
    - LINT_FILES=$(git diff --name-only origin/devel...HEAD | grep -E '\.py$' | grep -v '__[^/]*__' || true)
    - echo "Changed Python files:"
    - echo "$LINT_FILES"

# Check the changed files in the current branch with autopep8
# Don't run the check in the scheduled CI pipeline
autopep8:
  stage: lint
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - |
      changed_files=$(git diff --name-only origin/devel...HEAD | grep -E '\.py$' | grep -v '__[^/]*__' || true)
      echo "Changed Python files:"
      echo "$changed_files"
      if [ -n "$changed_files" ]; then
        pip install autopep8
        echo "Running autopep8 on changed files..."
        failure=0
        for file in $changed_files; do
          echo "Checking $file with autopep8..."
          diff_output=$(autopep8 --diff "$file")  # Capture the diff output
          if [ ${#diff_output} -eq 0 ]; then  # Check if the length of diff output is zero
              echo "$file: SUCCESS (PEP8 compliant)"
          else
              echo "$file: FAIL (Needs formatting)"
              failure=1
          fi
        done
        if [ "$failure" -eq 1 ]; then
          echo "Some files failed autopep8 check."
          exit 1
        else
          echo "All files passed autopep8 check."
        fi
      else
        echo "No Python files to check."
      fi
    - source env_$CI_PIPELINE_ID/bin/activate
  allow_failure: true


# Check the changed files in the current branch with isort
# Don't run the check in the scheduled CI pipeline
isort:
  stage: lint
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - pip install isort
    - |
      changed_files=$(git diff --name-only origin/devel...HEAD | grep -E '\.py$' | grep -v '__[^/]*__' || true)
      echo "Changed Python files:"
      echo "$changed_files"
      if [ -n "$changed_files" ]; then
        echo "Running isort on changed files..."
        echo "$changed_files" | xargs isort --profile black --check-only
      else
        echo "No Python files to check."
      fi
  allow_failure: true

# Check the changed files in the current branch with add-trailing-commas
# Don't run the check in the scheduled CI pipeline
# add-trailing-commas:
#   stage: lint
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#     # Don't run the check in the scheduled CI pipeline
#   script:
#     - pip install add-trailing-comma
#     - |
#       changed_files=$(git diff --name-only origin/devel...HEAD | grep -E '\.py$' | grep -v '__[^/]*__' || true)
#       echo "Changed Python files:"
#       echo "$changed_files"
#       if [ -n "$changed_files" ]; then
#         echo "Running add-trailing-commas on changed files..."
#         for file in $changed_files; do
#           echo "Processing $file..."
#           # Create a temporary file and format it
#           temp_file=$(mktemp)
#           cp "$file" "$temp_file"
#           add-trailing-comma "$temp_file"
          
#           # Compare the original file with the modified temporary file
#           if diff "$file" "$temp_file" > /dev/null; then
#             echo "$file is already correctly formatted."
#           else
#             diff "$file" "$temp_file"
#             exit 1
#           fi
          
#           # Clean up the temporary file
#           rm "$temp_file"
#         done
#       else
#         echo "No Python files to check."
#       fi
#   allow_failure: true


# # Lint struphy with `struphy lint`
# lint_struphy:
#   stage: lint
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
#       when: never
#     - if: $CI_COMMIT_MESSAGE =~ /make-pages/
#       when: never
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#       when: never
#     - if: $CI_COMMIT_TAG
#       when: never
#     - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
#   script:
#     - pwd
#     - ls -1
#     - git fetch origin
#     - pip install -e . # We have to install struphy in editable mode for struphy lint to work
#     - struphy
#     - struphy lint branch
#   allow_failure: true

##################
### TEST STAGE ###
##################

# ubuntu latest 
Ubuntu_latest:
  stage: test
  image: ubuntu:latest
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  needs: ['default_build']
  before_script:
    - date
    - ls -a
    - apt update -y && apt clean 
    - export DEBIAN_FRONTEND=noninteractive
    - apt install -y software-properties-common
    - add-apt-repository -y ppa:deadsnakes/ppa
    - apt update -y
    - apt install -y python3.11
    - apt install -y python3.11-dev
    - apt install -y python3-pip 
    - apt install -y python3.11-venv 
    - apt install -y gfortran gcc 
    - apt install -y liblapack-dev libopenmpi-dev 
    - apt install -y libblas-dev openmpi-bin 
    - apt install -y libomp-dev libomp5 
    - apt install -y git
    - apt install -y pandoc
    - apt install -y sqlite3
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
  script:
    - python3.11 -m pip list
    - python3.11 -m venv env
    - source env/bin/activate
    - pip install dist/struphy*.whl
    - struphy compile --status
    - make -v
    - struphy compile
    - struphy test models --fast

# default tests
c_unit_tests:
  stage: test
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test unit  
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

c_model_tests:
  stage: test
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test models --fast
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

c_model_cronjob_tests:
  stage: test
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test models --fast
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all
  artifacts:
    name: 'python-env-installed-2'
    paths:
      - env_$CI_PIPELINE_ID/
    expire_in: 1 day

c_tutorial_tests:
  stage: test
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "false" && $CI_PIPELINE_SOURCE == "push"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test tutorials --fast

# Cron-job Fortran install, after c tests:
fortran_cronjob_install:
  stage: test
  needs: ["c_model_cronjob_tests"]
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pip show struphy
    - pip list
    - struphy
    - pyccel --version
    - struphy compile --status
    - struphy compile --language=fortran -y # compiles struphy, psydac with language fortran
  artifacts:
    name: 'python-env-installed-3'
    paths:
      - env_$CI_PIPELINE_ID/
    expire_in: 1 day

fortran_unit_tests:
  stage: test
  needs: ["fortran_cronjob_install"]
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test unit 
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

fortran_model_tests:
  stage: test
  needs: ["fortran_cronjob_install"]
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test models --fast
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

fortran_tutorial_tests:
  stage: test
  needs: ["fortran_cronjob_install"]
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - pwd
    - ls -1
    - struphy compile --status
    - struphy test tutorials
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all

# docker image testing (scheduled: struphy from PyPI OR test-schedule: struphy from devel)
Ubuntu_23_04:
  stage: test
  image: ubuntu:23.04
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - ls -a
    - apt update -y && apt clean 
    - apt install -y python3-pip 
    - apt install -y python3-venv
    - apt install -y gfortran gcc 
    - DEBIAN_FRONTEND=noninteractive TZ="Europe/Berlin" apt-get install -y liblapack-dev libopenmpi-dev 
    - apt install -y libblas-dev openmpi-bin 
    - apt install -y libomp-dev libomp5 
    - apt install -y git
    - apt install -y pandoc
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
  script:
    - python3 -m venv env
    - source env/bin/activate
    - pip install --upgrade pip
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - struphy compile
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

struphy_ubuntu_python_3_11:
  stage: test
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_ubuntu_python_3_11
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - uname -a
    - ls -a
    - ls dist/
    - ls /
  script:
    - python3 -V
    - python3.11 -V
    - python3.11 -m venv env
    - source env/bin/activate
    - pip install --upgrade pip
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - struphy compile
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

Fedora:
  stage: test
  image: fedora:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - ls -a
    - dnf install -y wget yum-utils make openssl-devel bzip2-devel libffi-devel zlib-devel
    - dnf update -y  
    - dnf install -y gcc
    - dnf install -y gfortran  
    - dnf install -y blas-devel lapack-devel  
    - dnf install -y openmpi openmpi-devel 
    - dnf install -y libgomp 
    - dnf install -y git 
    - dnf install -y environment-modules 
    - dnf install -y python3-mpi4py-openmpi 
    - dnf install -y pandoc
    - dnf install -y sqlite-devel
    - wget https://www.python.org/ftp/python/3.10.14/Python-3.10.14.tgz 
    - tar xzf Python-3.10.14.tgz 
    - cd Python-3.10.14 
    - ./configure --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions 
    - make -j ${nproc} 
    - make altinstall 
    - cd ..
    - pwd
    - ls  
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    - mv /usr/local/lib/libpython3.10.a libpython3.10.a.bak
  script:
    - python3.10 -V
    - python3.10 -m venv env
    - source env/bin/activate
    - . /etc/profile.d/modules.sh
    - module load mpi/openmpi-$(arch)
    - module list 
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - struphy compile 
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

struphy_fedora_python_3_10:
  stage: test
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_fedora_python_3_10
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - uname -a
    - ls -a
    - ls dist/
    - ls /
  script:
    - python3.10 -V
    - python3.10 -m venv env
    - source env/bin/activate
    - . /etc/profile.d/modules.sh
    - module load mpi/openmpi-$(arch)
    - module list 
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - struphy compile 
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

OpenSuse:
  stage: test
  image: opensuse/tumbleweed:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - ls -a
    - zypper refresh
    - zypper install -y python311 python311-devel
    - zypper install -y python311-pip python3-virtualenv
    - zypper install -y gcc-fortran gcc 
    - zypper install -y lapack-devel openmpi-devel 
    - zypper install -y blas-devel openmpi 
    - zypper install -y libgomp1 
    - zypper install -y git 
    - zypper install -y pandoc 
    - zypper install -y sqlite3 
    - zypper install -y vim 
    - zypper install -y make
    - python3 -m venv /opensuse_latest/venv
    - export PATH="/opensuse_latest/venv/bin:$PATH"
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    - export OMPI_MCA_pml=ob1
    - export OMPI_MCA_btl=tcp,self
    - export PATH="/usr/lib64/mpi/gcc/openmpi4/bin/:$PATH"
    - export LD_LIBRARY_PATH="/usr/lib64/mpi/gcc/openmpi4/lib64:$LD_LIBRARY_PATH"
  script:
    - python3 -V
    - python3 -m pip list
    - python3 -m venv env
    - source env/bin/activate
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - struphy compile 
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

struphy_opensuse_python_3_11:
  stage: test
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_opensuse_python_3_11
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - uname -a
    - ls -a
    - ls dist/
    - ls /
  script:
    - python3 -V
    - python3 -m pip list
    - python3 -m venv env
    - source env/bin/activate
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - struphy compile 
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

AlmaLinux:
  stage: test
  image: almalinux:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - ls -a
    - yum install -y wget yum-utils make openssl-devel bzip2-devel libffi-devel zlib-devel
    - yum update -y 
    - yum clean all 
    - yum install -y gcc 
    - yum install -y gfortran  
    - yum install -y openmpi openmpi-devel  
    - yum install -y libgomp 
    - yum install -y git 
    - yum install -y environment-modules 
    - yum install -y sqlite-devel
    - wget https://www.python.org/ftp/python/3.10.14/Python-3.10.14.tgz 
    - tar xzf Python-3.10.14.tgz 
    - cd Python-3.10.14 
    - ./configure --with-system-ffi --with-computed-gotos --enable-loadable-sqlite-extensions 
    - make -j ${nproc} 
    - make altinstall 
    - cd ..
    - pwd
    - ls
    - export OMPI_ALLOW_RUN_AS_ROOT=1
    - export OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
    - export OMPI_MCA_pml=ob1
    - export OMPI_MCA_btl=tcp,self
    - export PATH="/usr/lib64/openmpi/bin:$PATH"
    - mv /usr/local/lib/libpython3.10.a libpython3.10.a.bak
  script:
    - python3.10 -m pip list
    - python3.10 -m venv env
    - source env/bin/activate
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - pip list
    - struphy compile 
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

struphy_almalinux_python_3_10:
  stage: test
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_almalinux_python_3_10
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
  needs: ['default_build']
  before_script:
    - date
    - uname -a
    - ls -a
    - ls dist/
    - ls /
  script:
    - python3.10 -m pip list
    - python3.10 -m venv env
    - source env/bin/activate
    - echo $CI_COMMIT_MESSAGE
    - if [ $CI_COMMIT_MESSAGE == test-schedule ]; then FILE=dist/struphy*.whl; else FILE=struphy; fi
    - echo $FILE
    - pip install $FILE
    - pip list
    - struphy compile 
    - struphy test models --fast
    - struphy compile --language=fortran -y 
    - struphy test models --fast

###################
### PAGES STAGE ###
###################

pages:
  image: gitlab-registry.mpcdf.mpg.de/struphy/struphy/struphy_ubuntu_python_3_11
  stage: pages
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_COMMIT_MESSAGE =~ /make-pages/
  needs: ['default_build']
  before_script:
    - date
    - uname -a
    - ls -a
    - ls dist/
    - ls /
    - apt show pandoc
    - apt show graphviz
    - python3 -V
    - python3.11 -V
    - python3.11 -m venv env
    - source env/bin/activate
    - pip install --upgrade pip
    - echo $CI_COMMIT_MESSAGE
    - pip install dist/struphy*.whl
  script:
    - struphy -h
    - struphy compile --status
    - struphy compile -y
    - struphy test tutorials
    - ls $(python3 -c "import struphy as _; print(_.__path__[0])")/io/out
    #- struphy test timings
    #- ls $(python3 -c "import struphy as _; print(_.__path__[0])")/_pymon --all
    - cd doc ; make html
    - mv _build/html/ ../public/
  artifacts:
    name: 'pages'
    paths:
      - public/

#####################
### RELEASE STAGE ###
#####################

deploy:
  stage: release
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master" 
  script:
    - twine upload dist/*

vars:
  stage: release
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master"
  before_script:
    - date
    - ls -a
    - uname -s # get system info
  script:
    - echo "VERSION=$(var=$(<pyproject.toml); set -- $var; echo ${14} | sed 's/^.//' | sed 's/.$//')" >> vars.env
  artifacts:
    name: 'vars'
    reports:
      dotenv: vars.env
    expire_in: 1 day

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /test-schedule/
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_REF_NAME == "master"
  needs: ['vars']
  before_script:
    - date
    - ls -a
    - uname -s # get system info
  script:
    - cat /etc/*-release
    - echo $VERSION
  release:                                         # See https://docs.gitlab.com/ee/ci/yaml/#release for available properties
    tag_name: 'v$VERSION'                          # The version is incremented per pipeline.
    name: 'v$VERSION'
    ref: '$CI_COMMIT_SHA'                          # The tag is created from the pipeline SHA.
    description: 'CHANGELOG.md'
    assets:
      links:
        - name: 'Documentation'
          url: 'https://struphy.pages.mpcdf.de/struphy/index.html'
        - name: 'PyPI'
          url: 'https://pypi.org/project/struphy/'