#!/bin/bash -e

# Python interpreter
PYTHON=python3

# Struphy installation path
cd ~
STRUPHY=$($PYTHON -c "import struphy as _; print(_.__path__[0])")

# Defaults
RUN=false
UNITS=false
COMPILE=false 
PROFILE=false
PPROC=false
PROFILE_ALL=false 
REPLACE=false 
N_LINES=6     
FLAGS=
CFLAGS=--openmp    
MODEL=                                 
INPUT=parameters.yml            
INPUT_ABS=        
OUTPUT=sim_1           
OUTPUT_ABS=   
BATCH=false            
BATCH_SCRIPT=     
BATCH_SCRIPT_ABS=         
RESTART=false
RUNTIME=300
MPI_SIZE=1
DEBUG=
CELLDIVIDE=1
RUN_CMD=$PYTHON
EXAMPLE=
SERIAL=true
CODES=

# Help displayed
function struphy_help {
    echo "STRUPHY - STRUcture-Preserving HYbrid codes"
    echo
    echo "Usage: struphy [OPTIONS] [COMMAND]"
    echo 
    echo "Options:"
    echo "  -h, --help      This help"
    echo "  -p, --path      Default installation and i/o paths"
    echo "  -v, --version   Installed version"
    echo
    echo "Commands:"
    echo "  compile   Compile struphy kernels"
    echo "  run       Run a struphy model"
    echo "  units     Show units and some import physics quantities of a specific model"
    echo "  profile   Profile finished struphy runs"
    echo "  pproc     Post process data from finished struphy runs"
    echo "  example   Run complete struphy examples with post processing and plotting"
    echo "  test      Run struphy tests"
    echo 
    echo "Run 'struphy COMMAND --help' for more information on a command."
}

function compile_help {
    echo
    echo "Usage: struphy compile [OPTIONS]"
    echo
    echo "Compile struphy kernels using pyccel, https://github.com/pyccel/pyccel."
    echo 
    echo "Options:"
    echo "  --no-openmp   Compile without OpenMP"
    echo "  --delete      Remove .f90 and .so files (for running pure Python code)"
    echo "  --verbose     Call pyccel with --verbose compiler option"
}

function run_help {
    echo
    echo "Usage: struphy run MODEL [-i FILE] [-o DIR]"
    echo "                         [--input-abs FILE] [--output-abs DIR]"
    echo "                         [-b FILE] [--batch-abs FILE]"
    echo "                         [-r] [--restart]"
    echo "                         [--run-time TIME]"
    echo "                         [--mpi N]"
    echo
    echo "Run a struphy model."
    echo 
    echo "Models:"
    echo "  Maxwell               Maxwell equations in vacuum"
    echo "  LinearMHD             Linear ideal MHD with zero-flow equilibrium"
    echo "  LinearVlasovMaxwell   Linearized Vlasov Maxwell system with Maxwellian background"
    echo "  LinearMHDVlasovCC     Linear ideal MHD with zero-flow equilibrium and 6d kinetic energetic ion species"
    echo 
    echo "  See https://struphy.pages.mpcdf.de/struphy/sections/models.html for more info on available models."
    echo 
    echo "Options:"
    echo "  -i, --input     Parameter FILE (.yml) relative to install_path/struphy/io/inp/, the default is 'parameters.yml'"
    echo "  --input-abs     Parameter FILE (.yml), absolute path"
    echo "  -o, --output    Output directory DIR relative to install_path/struphy/io/out/, the default is 'sim_1'"  
    echo "  --output-abs    Output directory DIR, absolute path"  
    echo "  -b, --batch     Batch script FILE relative to install_path/struphy/io/batch/"
    echo "  --batch-abs     Batch script FILE, absolute path"
    echo "  --run-time      Maximum run time of program in minutes. Will stop the simulation after this time even if Tend in parameter file is not reached, default is 300 (5 hours)"
    echo "  -r, --restart   Restart an exisiting simulation, number of MPI processes must be compatible"
    echo "  --mpi           Use 'mpirun -n N' to launch struphy"
    echo "  --debug         Launch a Cobra debug run, see https://docs.mpcdf.mpg.de/doc/computing/cobra-user-guide.html#interactive-debug-runs"
}

function profile_help {
    echo
    echo "Usage: struphy profile [OPTIONS] DIR_1 [DIR_2 ...]"
    echo
    echo "Profile finished struphy runs."
    echo "Here DIR_1, DIR_2 are directories relative to install_path/struphy/io/out/,"
    echo "containing struphy simulation data obtained from the same (!) model."
    echo
    echo "Options:"
    echo "  -a, --all         Profile all functions called in struphy. The default strings are stated in https://struphy.pages.mpcdf.de/struphy/sections/userguide.html#code-profiling"
    echo "  --replace         Replace propagator keys from Cprofile with class names for nicer output."
    echo "  --n-lines <int>   Plot <int> most time consuming calls in profiling analysis (default=6)."
}

function pproc_help {
    echo
    echo "Usage: struphy pproc [--celldivide N] DIR_1 [DIR_2 ...]"
    echo
    echo "Post process data from finished struphy run."
    echo "See https://struphy.pages.mpcdf.de/struphy/sections/userguide.html#post-processing for details."
    echo
    echo "Options:"
    echo "  --celldivide    Divide each grid cell by N for field evaluation, default is N=1."
}

function example_help {
    echo
    echo "Usage: struphy example CASE"
    echo
    echo "Run a complete struphy example, including post processing and plotting."
    echo
    echo "Cases:"
    echo "  maxwell             1d Maxwell equations in vacuum, dispersion relation, 1 MPI process."
    echo "  maxwell_mpi         1d Maxwell equations in vacuum, dispersion relation, 3 MPI processes."
    echo "  linearmhd           1d linear ideal MHD equations, dispersion relation, 4 MPI processes."
    echo "  orbits_tokamak      full-orbit particle trajectories in a tokamak-like static magnetic field, 2 MPI processes."
    echo "  gc_orbits_tokamak   guiding center particle trajectories in a tokamak-like static magnetic field, 4 MPI processes."
    echo "  TAE_tokamak         3d linear ideal MHD equations, initialized with m=2,3, n=-2 toroidal AlfvÃ©n eigenmode (TAE), 2 MPI processes (takes ~50 minutes on a laptop)."
    echo "  linearmhdvlasov_cc  1d hybrid linear ideal MHD equations + full-orbit (6d) energetic ions (current coupling model), 2 MPI processes."

}

function test_help {
    echo
    echo "Usage: struphy test [OPTIONS]"
    echo
    echo "Run available struphy tests. If no options are given, all available unit tests are run (2 processes for parallel tests)."
    echo 
    echo "Options:"
    echo "  --serial    Run only serial unit tests."
    echo "  --mpi N     Use 'mpirun -n N' to run only parallel unit tests."
    echo "  --codes     Run code tests."
}

function units_help {
    echo
    echo "Usage: struphy units MODEL [-i FILE] [--input-abs FILE]"
    echo
    echo "Show units and some import physics quantities of a specific model."
    echo 
    echo "Options:"
    echo "  -i, --input     Parameter FILE (.yml) relative to install_path/struphy/io/inp/, the default is 'parameters.yml'"
    echo "  --input-abs     Parameter FILE (.yml), absolute path"
}

# No arguments - display help and exit
if [ $# -eq 0 ]; then
    struphy_help
    exit 0
fi

POSITIONAL_ARGS=()

# Scan arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      struphy_help
      exit 0
      ;;
    -p|--path)
      echo "Struphy installation path:" $STRUPHY
      echo "default input:            " $STRUPHY/io/inp 
      echo "default output:           " $STRUPHY/io/out
      echo "template batch scripts:   " $STRUPHY/io/batch
      exit 0
      ;;
    -v|--version)
      $PYTHON $STRUPHY/version.py
      exit 0
      ;;
    run) 
      RUN=true
      case $2 in
        --help)
          run_help
          exit 0
          ;;
      esac
      MODEL="$2"
      shift
      shift
      ;;
    compile)
      COMPILE=true
      case $2 in
        --help)
          compile_help
          exit 0
          ;;
      esac
      shift
      ;;
    profile)
      PROFILE=true
      case $2 in
        --help)
          profile_help
          exit 0
          ;;
      esac
      shift
      ;;
    pproc)
      PPROC=true
      case $2 in
        --help)
          pproc_help
          exit 0
          ;;
      esac
      shift
      ;;
    example) 
      case $2 in
        --help)
          example_help
          exit 0
          ;;
      esac
      EXAMPLE="$2"
      shift
      shift
      ;;
    test)
      TEST=true 
      case $2 in
        --help)
          test_help
          exit 0
          ;;
      esac
      shift
      ;;
    units)
      UNITS=true 
      case $2 in
        --help)
          units_help
          exit 0
          ;;
      esac
      MODEL="$2"
      shift
      ;;
    -a|--all)
      PROFILE_ALL=true
      shift 
      ;;
    --replace)
      REPLACE=true
      shift 
      ;;
    --n-lines)
      N_LINES="$2"
      shift
      shift
      ;;
    --no-openmp)
      CFLAGS=
      shift 
      ;;
    --delete)
      CLEAN=true
      shift 
      ;;
    --verbose)
      FLAGS=--verbose
      shift 
      ;;
    --serial)
      MPI_SIZE=
      shift 
      ;;
    --codes)
      SERIAL=false
      MPI_SIZE=
      CODES=true
      shift 
      ;;
    -i|--input)
      INPUT="$2"
      shift
      shift
      ;;
    --input-abs)
      INPUT_ABS="$2"
      shift
      shift
      ;;
    -o|--output)
      OUTPUT="$2"
      shift
      shift
      ;;
    --output-abs)
      OUTPUT_ABS="$2"
      shift
      shift
      ;;
    -b|--batch)
      BATCH=true
      BATCH_SCRIPT="$2"
      shift
      shift
      ;;
    --batch-abs)
      BATCH=true
      BATCH_SCRIPT_ABS="$2"
      shift
      shift
      ;;
    -r|--restart)
      RESTART=true
      shift
      ;;
    --run-time)
      RUNTIME="$2"
      shift
      shift
      ;;
    --mpi)
      MPI_SIZE="$2"
      SERIAL=false
      shift
      shift
      ;;
    --debug)
      DEBUG=true
      shift
      ;;
    --celldivide)
      CELLDIVIDE="$2"
      shift
      shift
      ;;
    -*|--*)
      echo "Unknown option $1"
      exit 1
      ;;
    *)
      POSITIONAL_ARGS+=("$1") # save positional arg
      shift # past argument
      ;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters

# Code compilation
if [ "$COMPILE" = true ]; then

  # Print parameters
  echo "Makefile: $STRUPHY/compile_struphy.mk"
  echo "COMPILE = ${COMPILE}"
  echo "FLAGS  = ${FLAGS}"
  echo "CFLAGS  = ${CFLAGS}"
  echo "CLEAN   = ${CLEAN}"

  if [ "$CLEAN" = true ]; then
    echo "Start cleaning up struphy..."
    cd .. # change dir not be in source path
    command make clean -f $STRUPHY/compile_struphy.mk struphy_path=$STRUPHY
    exit 0
  else
    echo "Start compiling struphy..."
    cd .. # change dir not be in source path
    compile_gvec_to_python
    command make -f $STRUPHY/compile_struphy.mk struphy_path=$STRUPHY flags_openmp_pic=$CFLAGS flags=$FLAGS
    exit 0
  fi

fi

# Run
if [ "$RUN" = true ] ; then

  # In-/output paths
  if [ -z $INPUT_ABS ]; then
    INPUT_ABS=$STRUPHY/io/inp/$INPUT
  fi
  
  if [ -z $OUTPUT_ABS ]; then
    OUTPUT_ABS=$STRUPHY/io/out/$OUTPUT
  fi
  
  # For restarts, take the parameter file in the output folder as an input
  if [ "$RESTART" = true ] ; then
    INPUT_ABS=$OUTPUT_ABS/parameters.yml
  fi

  # Create ouput folder OR clear output folder if it already exists
  if [ -d $OUTPUT_ABS ]; then
    echo "Output folder already exists: clean it"
    tmp_path=$(pwd)
    cd $OUTPUT_ABS
    rm -rf */
    if [ "$RESTART" = true ] ; then
      find . -type f -not \( -name '*.yml' -or -name '*.npy' -or -name '*.hdf5' \) -delete
    else
      find . -type f -not \( -name '*.yml' -or -name '*.npy' \) -delete
    fi
    cd $tmp_path
  else
    mkdir $OUTPUT_ABS
  fi
  
  # Copy parameters there (if not already at right place)
  if [ $INPUT_ABS -ef $OUTPUT_ABS/parameters.yml ]; then
    :
  else
    cp $INPUT_ABS $OUTPUT_ABS/parameters.yml
  fi
  METAFILE=$OUTPUT_ABS/meta.txt 

  # Run flags
  CPROFILE="-m cProfile -o $OUTPUT_ABS/profile_tmp -s time $STRUPHY/main.py"
  ARGS="$MODEL $INPUT_ABS $OUTPUT_ABS/ None $METAFILE $RESTART $RUNTIME"

  # Normal run  
  RUN_CMD="$PYTHON $CPROFILE $ARGS"  

  # MPI mode
  if [ "$MPI_SIZE" ]; then
    RUN_CMD="mpirun -n $MPI_SIZE $PYTHON $CPROFILE $ARGS"
  fi

  # Debug run on Cobra (overwrite run command from MPI mode)
  if [ "$DEBUG" ]; then
    RUN_CMD="srun -n $MPI_SIZE -p interactive --time=119 --mem=2000 $PYTHON $CPROFILE $ARGS"
  fi

  # Batch mode
  if [ "$BATCH" = true ]; then

    if [ -z $BATCH_SCRIPT_ABS ]; then
      BATCH_SCRIPT_ABS=$STRUPHY/io/batch/$BATCH_SCRIPT
    fi

    chmod +x $BATCH_SCRIPT_ABS

    # Check if batch script already has an "srun" command; if yes, remove
    LASTLINE=$(tail -1 $BATCH_SCRIPT_ABS)

    if [[ $LASTLINE == *"srun"* ]]; then
      sed -i '$ d' $BATCH_SCRIPT_ABS
      sed -i '$ d' $BATCH_SCRIPT_ABS
    elif [ "$LASTLINE" ]; then
      echo -e "\n" >> $BATCH_SCRIPT_ABS 
    fi

    # Append run command to batch script
    echo "# Run command added by Struphy" >> $BATCH_SCRIPT_ABS
    echo "srun $PYTHON $CPROFILE $ARGS> $OUTPUT_ABS/struphy.out" >> $BATCH_SCRIPT_ABS

    RUN_CMD="sbatch $BATCH_SCRIPT_ABS"

  fi

  # Print parameters
  echo "STRUPHY          = ${STRUPHY}"
  echo "RUN              = ${RUN}"
  echo "MODEL            = ${MODEL}"
  echo "RESTART          = ${RESTART}"
  echo "RUNTIME          = ${RUNTIME}"
  echo "MPI_SIZE         = ${MPI_SIZE}"
  echo "INPUT_ABS        = ${INPUT_ABS}"
  echo "OUTPUT_ABS       = ${OUTPUT_ABS}"
  echo "BATCH_SCRIPT_ABS = ${BATCH_SCRIPT_ABS}"
  #echo "RUN_CMD          = ${RUN_CMD}"
  echo "METAFILE         = ${METAFILE}"

  # Write to meta.txt
  echo "STRUPHY          = ${STRUPHY}" >> $METAFILE
  echo "MODEL            = ${MODEL}" >> $METAFILE
  echo "RESTART          = ${RESTART}" >> $METAFILE
  echo "MPI_SIZE         = ${MPI_SIZE}" >> $METAFILE
  echo "INPUT_ABS        = ${INPUT_ABS}" >> $METAFILE
  echo "OUTPUT_ABS       = ${OUTPUT_ABS}" >> $METAFILE
  echo "BATCH_SCRIPT_ABS = ${BATCH_SCRIPT_ABS}" >> $METAFILE
  echo "RUN_CMD          = ${RUN_CMD}" >> $METAFILE
  echo "METAFILE         = ${METAFILE}" >> $METAFILE

  # Start code
  $RUN_CMD

fi

# Model units
if [ "$UNITS" = true ]; then

  # Input path
  if [ -z $INPUT_ABS ]; then
    INPUT_ABS=$STRUPHY/io/inp/$INPUT
  fi
  
  # Print parameters
  echo "STRUPHY   = ${STRUPHY}"
  echo "UNITS     = ${UNITS}"
  echo "MODEL     = ${MODEL}"
  echo "INPUT_ABS = ${INPUT_ABS}"
  
  # Start code
  $PYTHON $STRUPHY/main.py $MODEL $INPUT_ABS

fi

# Profile runs
if [ "$PROFILE" = true ]; then

  if (( ${#POSITIONAL_ARGS[@]} == 0 )); then

    echo "  ERROR: no simulation folders to profile specified."
    exit 1

  else

    folders=()
    for i in ${POSITIONAL_ARGS[@]}; do
      folders+=($STRUPHY/io/out/$i/)
    done

    # Print parameters
    echo "Executing $STRUPHY/post_processing/profile_struphy.py"
    echo "PROFILE_ALL = $PROFILE_ALL"
    echo "REPLACE = $REPLACE"
    echo "N_LINES = $N_LINES"
    echo "folders  = ${folders[*]}"

    $PYTHON $STRUPHY/post_processing/profile_struphy.py $PROFILE_ALL $REPLACE $N_LINES ${folders[@]}

  fi

fi

# Post processing
if [ "$PPROC" = true ]; then

  if (( ${#POSITIONAL_ARGS[@]} == 0 )); then

    echo "  ERROR: no simulation folders to post process specified."
    exit 1

  else

    folders=()
    for i in ${POSITIONAL_ARGS[@]}; do
      folders+=($STRUPHY/io/out/$i/)
    done

    # Print parameters
    echo "Executing $STRUPHY/post_processing/pproc_struphy.py"
    echo "CELLDIVIDE = $CELLDIVIDE"
    echo "folders  = ${folders[*]}"

    $PYTHON $STRUPHY/post_processing/pproc_struphy.py $CELLDIVIDE ${folders[@]}

  fi

fi

# Examples
if [ $EXAMPLE ]; then

  if [ "$EXAMPLE" == maxwell ]; then
    example_maxwell_serial
  elif [ "$EXAMPLE" == maxwell_mpi ]; then
    example_maxwell_mpi_3
  elif [ "$EXAMPLE" == linearmhd ]; then
    example_linearmhd_mpi_4
  elif [ "$EXAMPLE" == orbits_tokamak ]; then
    example_orbits_tokamak_mpi_2
  elif [ "$EXAMPLE" == gc_orbits_tokamak ]; then
    example_gc_orbits_tokamak_mpi_4
  elif [ "$EXAMPLE" == TAE_tokamak ]; then
    example_TAE_tokamak_mpi_2
  elif [ "$EXAMPLE" == linearmhdvlasov_cc ]; then
    example_hybridmhdvlasovcc_mpi_2
  else
    echo "Example $EXAMPLE not implemented."
  fi

fi

# Unit tetst
if [ $TEST ]; then

  if [ $SERIAL == true ]; then
    cd $STRUPHY/tests/tests_serial
    echo "Unit tests from $STRUPHY/tests/tests_serial"
    pytest
  fi

  if [ $MPI_SIZE ]; then 
    cd $STRUPHY/tests/tests_mpi
    echo "Unit tests from $STRUPHY/tests/tests_mpi"
    if (($MPI_SIZE == 1)); then
      MPI_SIZE=2
    fi
    mpirun -n $MPI_SIZE pytest --with-mpi
  fi

  if [ $CODES ]; then
    echo "Code tests from bin/code_tests"
    code_tests
  fi
  
fi


